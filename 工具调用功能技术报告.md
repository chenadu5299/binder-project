# AI å·¥å…·è°ƒç”¨åŠŸèƒ½å®Œæ•´æŠ€æœ¯æŠ¥å‘Š

## ç›®å½•
1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ•°æ®æµ](#æ•°æ®æµ)
4. [å…³é”®å®ç°ç»†èŠ‚](#å…³é”®å®ç°ç»†èŠ‚)
5. [é—®é¢˜åˆ†æ](#é—®é¢˜åˆ†æ)
6. [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
7. [ç›¸å…³æ–‡ä»¶æ¸…å•](#ç›¸å…³æ–‡ä»¶æ¸…å•)
8. [è°ƒè¯•æŒ‡å—](#è°ƒè¯•æŒ‡å—)
9. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## åŠŸèƒ½æ¦‚è¿°

### åŠŸèƒ½æè¿°
AI å·¥å…·è°ƒç”¨åŠŸèƒ½å…è®¸ AI æ¨¡å‹åœ¨æ‰§è¡Œå¯¹è¯æ—¶è°ƒç”¨åç«¯å·¥å…·ï¼ˆå¦‚åˆ›å»ºæ–‡ä»¶ã€è¯»å–æ–‡ä»¶ã€ç¼–è¾‘æ–‡æ¡£ç­‰ï¼‰ï¼Œå®ç° Agent æ¨¡å¼çš„èƒ½åŠ›ã€‚AI å¯ä»¥é€šè¿‡å·¥å…·è°ƒç”¨æ¥æ‰§è¡Œå®é™…çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œå’Œç¼–è¾‘å™¨æ“ä½œã€‚

### æ ¸å¿ƒç‰¹æ€§
- **æµå¼å·¥å…·è°ƒç”¨**ï¼šæ”¯æŒåœ¨æµå¼å“åº”ä¸­æ¥æ”¶å·¥å…·è°ƒç”¨
- **å‚æ•°ç´¯ç§¯**ï¼šè‡ªåŠ¨ç´¯ç§¯æµå¼ä¼ è¾“çš„å·¥å…·è°ƒç”¨å‚æ•°
- **çŠ¶æ€ç®¡ç†**ï¼šè·Ÿè¸ªå·¥å…·è°ƒç”¨çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆpending â†’ executing â†’ completed/failedï¼‰
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œ JSON ä¿®å¤æœºåˆ¶
- **å‰ç«¯å±•ç¤º**ï¼šå®æ—¶æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€å’Œç»“æœ

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Provider    â”‚ (DeepSeek/OpenAI)
â”‚  (deepseek.rs)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ æµå¼å“åº” (ChatChunk)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Commands    â”‚ (ai_commands.rs)
â”‚  - ç´¯ç§¯å‚æ•°     â”‚
â”‚  - æ‰§è¡Œå·¥å…·     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Tauri Event
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend       â”‚ (ChatPanel.tsx)
â”‚  - è§£æ JSON    â”‚
â”‚  - æ˜¾ç¤ºçŠ¶æ€     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool Service   â”‚ (tool_service.rs)
â”‚  - æ‰§è¡Œå·¥å…·     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

1. **AI Provider â†’ AI Commands**
   - æµå¼æ¥æ”¶ `ChatChunk::ToolCall`
   - ç´¯ç§¯ `arguments` å­—ç¬¦ä¸²
   - æ£€æµ‹ JSON å®Œæ•´æ€§

2. **AI Commands â†’ Frontend**
   - å‘é€ Tauri äº‹ä»¶ `ai-chat-stream`
   - åŒ…å«å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼ˆid, name, arguments, statusï¼‰

3. **Frontend â†’ Tool Service**
   - è§£æ JSON arguments
   - æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€
   - ç”¨æˆ·ç¡®è®¤åæ‰§è¡Œï¼ˆå¯é€‰ï¼‰

4. **Tool Service â†’ Frontend**
   - è¿”å›æ‰§è¡Œç»“æœ
   - æ›´æ–°å·¥å…·è°ƒç”¨çŠ¶æ€

---

## æ•°æ®æµ

### 1. æµå¼å“åº”å¤„ç†ï¼ˆdeepseek.rsï¼‰

```rust
// çŠ¶æ€ç®¡ç†ï¼šä½¿ç”¨ Arc<Mutex<>> åœ¨å¼‚æ­¥æµä¸­ä¿æŒçŠ¶æ€
let tool_call_state = Arc::new(Mutex::new((
    Option::<String>::None,  // tool_call_id
    Option::<String>::None,  // tool_call_name
    String::new(),            // tool_call_arguments (ç´¯ç§¯)
)));

// æµå¼å¤„ç†
let stream = response.bytes_stream();
let stream = stream.map(move |result| {
    // è§£æ SSE æ ¼å¼çš„å“åº”
    // ç´¯ç§¯ arguments: state_guard.2.push_str(arguments)
    // æ£€æŸ¥å®Œæ•´æ€§: args_str.trim().ends_with('}') && JSON.parse().is_ok()
    // è¿”å› ChatChunk::ToolCall { is_complete: true/false }
});
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `Arc<Mutex<>>` åœ¨å¼‚æ­¥æµä¸­å…±äº«çŠ¶æ€
- æ¯æ¬¡æ”¶åˆ° `function.arguments` delta æ—¶ï¼Œä½¿ç”¨ `push_str` ç´¯ç§¯
- æ£€æŸ¥ JSON å®Œæ•´æ€§ï¼šä»¥ `}` ç»“å°¾ä¸”å¯è§£æ
- åªåœ¨ `is_complete: true` æ—¶è¿”å›å®Œæ•´çš„å·¥å…·è°ƒç”¨

### 2. å·¥å…·è°ƒç”¨å¤„ç†ï¼ˆai_commands.rsï¼‰

```rust
// ä½¿ç”¨ HashMap ç®¡ç†å¤šä¸ªå·¥å…·è°ƒç”¨
let mut tool_calls: HashMap<String, (String, String)> = HashMap::new();

// å¤„ç† ChatChunk::ToolCall
match chunk {
    ChatChunk::ToolCall { id, name, arguments, is_complete } => {
        // ä¿å­˜çŠ¶æ€
        let entry = tool_calls.entry(id.clone()).or_insert_with(|| (name.clone(), String::new()));
        entry.1 = arguments.clone();
        
        // åªåœ¨å®Œæˆæ—¶æ‰§è¡Œ
        if is_complete {
            // 1. è§£æ JSON
            let parsed_arguments = serde_json::from_str::<serde_json::Value>(&arguments)?;
            
            // 2. å‘é€äº‹ä»¶åˆ°å‰ç«¯
            app_handle.emit("ai-chat-stream", payload)?;
            
            // 3. æ‰§è¡Œå·¥å…·
            let tool_call = ToolCall { id, name, arguments: parsed_arguments };
            let result = tool_service.execute_tool(&tool_call, &workspace_path).await?;
            
            // 4. å‘é€ç»“æœåˆ°å‰ç«¯
            app_handle.emit("ai-chat-stream", result_payload)?;
        }
    }
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `HashMap` ç®¡ç†å¤šä¸ªå¹¶å‘çš„å·¥å…·è°ƒç”¨
- åªåœ¨ `is_complete: true` æ—¶æ‰§è¡Œå·¥å…·
- å…ˆå‘é€äº‹ä»¶åˆ°å‰ç«¯ï¼Œå†æ‰§è¡Œå·¥å…·ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰

### 3. å‰ç«¯å¤„ç†ï¼ˆChatPanel.tsxï¼‰

```typescript
// ç›‘å¬ Tauri äº‹ä»¶
listen('ai-chat-stream', (event) => {
    const payload = event.payload;
    
    if (payload.tool_call) {
        const toolCall = payload.tool_call;
        
        // 1. æ£€æŸ¥ç©º arguments
        if (toolCall.arguments.trim() === '') return;
        
        // 2. è§£æ JSONï¼ˆåªåœ¨å®Œæˆ/å¤±è´¥æ—¶ï¼‰
        if (toolCall.status === 'completed' || toolCall.status === 'failed') {
            try {
                parsedArguments = JSON.parse(toolCall.arguments);
            } catch (e) {
                // 3. JSON ä¿®å¤é€»è¾‘
                parsedArguments = repairJSON(toolCall.arguments);
            }
        }
        
        // 4. æ›´æ–°çŠ¶æ€
        addToolCall(tabId, messageId, toolCallObj);
    }
});
```

**å…³é”®ç‚¹**ï¼š
- åªåœ¨ `status === 'completed' || 'failed'` æ—¶è§£æ JSON
- å®ç° JSON ä¿®å¤é€»è¾‘ï¼ˆä¿®å¤ç¼ºå¤±å¼•å·ã€æ‹¬å·ç­‰ï¼‰
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å…³é”®å‚æ•°ä½œä¸ºåå¤‡æ–¹æ¡ˆ

---

## å…³é”®å®ç°ç»†èŠ‚

### 1. å‚æ•°ç´¯ç§¯æœºåˆ¶

**é—®é¢˜**ï¼šæµå¼å“åº”ä¸­ï¼Œ`arguments` æ˜¯åˆ†å—ä¼ è¾“çš„ï¼Œéœ€è¦ç´¯ç§¯ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```rust
// deepseek.rs
if let Some(arguments) = &function.arguments {
    state_guard.2.push_str(arguments);  // ç´¯ç§¯å­—ç¬¦ä¸²
}
```

**å®Œæ•´æ€§æ£€æµ‹**ï¼š
```rust
let is_complete = args_str.trim().ends_with('}') && 
                  serde_json::from_str::<serde_json::Value>(&args_str).is_ok();
```

### 2. çŠ¶æ€ç®¡ç†

**åç«¯çŠ¶æ€**ï¼š
- `tool_call_state: Arc<Mutex<(id, name, arguments)>>` - åœ¨æµä¸­ä¿æŒçŠ¶æ€
- `tool_calls: HashMap<String, (name, arguments)>` - ç®¡ç†å¤šä¸ªå·¥å…·è°ƒç”¨

**å‰ç«¯çŠ¶æ€**ï¼š
- `ChatMessage.toolCalls: ToolCall[]` - æ¯ä¸ªæ¶ˆæ¯çš„å·¥å…·è°ƒç”¨åˆ—è¡¨
- `ToolCall.status: 'pending' | 'executing' | 'completed' | 'failed'`

### 3. JSON ä¿®å¤é€»è¾‘

**å¸¸è§é”™è¯¯**ï¼š
1. ç¼ºå¤±å¼•å·ï¼š`{path:test}` â†’ `{"path":"test"}`
2. ç¼ºå¤±ç»“æŸæ‹¬å·ï¼š`{"path":"test"` â†’ `{"path":"test"}`
3. è½¬ä¹‰å­—ç¬¦é”™è¯¯ï¼š`\"` â†’ `"`
4. å€¼ç¼ºå°‘å¼•å·ï¼š`"path":"test"` â†’ `"path":"test"`ï¼ˆå¦‚æœå€¼åº”è¯¥æ˜¯å­—ç¬¦ä¸²ï¼‰

**ä¿®å¤å®ç°**ï¼š
```typescript
// 1. ä¿®å¤ç¼ºå¤±çš„å¼•å·ï¼ˆé”®åï¼‰
repairedJson = repairedJson.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');

// 2. ä¿®å¤ç¼ºå¤±çš„ç»“æŸæ‹¬å·
if (repairedJson.startsWith('{') && !repairedJson.endsWith('}')) {
    repairedJson = repairedJson.replace(/,\s*$/, '');
    repairedJson += '}';
}

// 3. ä¿®å¤è½¬ä¹‰å­—ç¬¦
repairedJson = repairedJson.replace(/\\"/g, '"');
repairedJson = repairedJson.replace(/\\\\/g, '\\');

// 4. ä¿®å¤å€¼ç¼ºå°‘å¼•å·
repairedJson = repairedJson.replace(/:\s*([^",\[\]{}]+)([,}])/g, (match, value, suffix) => {
    if (!/^(true|false|null|\d+)$/.test(value.trim())) {
        return `: "${value.trim()}"${suffix}`;
    }
    return match;
});
```

**åå¤‡æ–¹æ¡ˆ**ï¼š
```typescript
// å¦‚æœä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å…³é”®å‚æ•°
const pathMatch = argsStr.match(/["']?path["']?\s*[:=]\s*["']?([^"',}]+)["']?/i);
const contentMatch = argsStr.match(/["']?content["']?\s*[:=]\s*["']?([^"']+)["']?/i);
```

---

## é—®é¢˜åˆ†æ

### é—®é¢˜ 1: JSON è§£æå¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
SyntaxError: JSON Parse error: Unexpected identifier "test"
æŸåçš„ JSON: "{\"\":test\",content \"# Document\\n is testdown.\""
```

**åŸå› åˆ†æ**ï¼š
1. **æµå¼ä¼ è¾“é—®é¢˜**ï¼š`arguments` åœ¨æµå¼ä¼ è¾“ä¸­å¯èƒ½ä¸å®Œæ•´
2. **ç´¯ç§¯é”™è¯¯**ï¼šåç«¯ç´¯ç§¯é€»è¾‘å¯èƒ½æœ‰é—®é¢˜
3. **å‰ç«¯è¿‡æ—©è§£æ**ï¼šåœ¨ `status === 'executing'` æ—¶å°è¯•è§£æ JSON

**æ ¹æœ¬åŸå› **ï¼š
- DeepSeek API è¿”å›çš„ `arguments` delta å¯èƒ½åŒ…å«ä¸å®Œæ•´çš„ JSON
- å‰ç«¯åœ¨å·¥å…·è°ƒç”¨æ‰§è¡Œä¸­ï¼ˆ`executing`ï¼‰å°±å°è¯•è§£æ JSON
- JSON ä¿®å¤é€»è¾‘ä¸å¤Ÿå®Œå–„

### é—®é¢˜ 2: å‚æ•°ç´¯ç§¯ä¸¢å¤±

**ç°è±¡**ï¼šå·¥å…·è°ƒç”¨ç¼ºå°‘ `path` å‚æ•°

**åŸå› **ï¼š
- `ai_commands.rs` ä¸­ä½¿ç”¨ `entry.1 = arguments.clone()` æ›¿æ¢è€Œä¸æ˜¯ç´¯ç§¯
- è™½ç„¶ `deepseek.rs` å·²ç»ç´¯ç§¯ï¼Œä½† `ai_commands.rs` åº”è¯¥ç›´æ¥ä½¿ç”¨ç´¯ç§¯åçš„å€¼

### é—®é¢˜ 3: ç½‘ç»œè¿æ¥é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ç½‘ç»œé”™è¯¯: è¯·æ±‚å¤±è´¥: error sending request for url (https://api.deepseek.com/v1/chat/completions): 
error trying to connect: connection closed via error
```

**åŸå› **ï¼š
- HTTP å®¢æˆ·ç«¯é…ç½®ä¸å½“
- ç¼ºå°‘é‡è¯•æœºåˆ¶
- è¶…æ—¶è®¾ç½®è¿‡çŸ­

---

## è§£å†³æ–¹æ¡ˆ

### è§£å†³æ–¹æ¡ˆ 1: å®Œå–„å‚æ•°ç´¯ç§¯é€»è¾‘

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src-tauri/src/services/ai_providers/deepseek.rs`

```rust
// ä½¿ç”¨ Arc<Mutex<>> åœ¨æµä¸­ä¿æŒçŠ¶æ€
let tool_call_state = Arc::new(Mutex::new((
    Option::<String>::None,
    Option::<String>::None,
    String::new(),
)));

// ç´¯ç§¯ arguments
if let Some(arguments) = &function.arguments {
    state_guard.2.push_str(arguments);
}

// æ£€æŸ¥å®Œæ•´æ€§
let is_complete = args_str.trim().ends_with('}') && 
                  serde_json::from_str::<serde_json::Value>(&args_str).is_ok();
```

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src-tauri/src/commands/ai_commands.rs`

```rust
// ç›´æ¥ä½¿ç”¨ deepseek.rs å·²ç´¯ç§¯çš„ arguments
let entry = tool_calls.entry(id.clone()).or_insert_with(|| (name.clone(), String::new()));
entry.1 = arguments.clone();  // deepseek.rs å·²ç»ç´¯ç§¯ï¼Œç›´æ¥ä½¿ç”¨
```

### è§£å†³æ–¹æ¡ˆ 2: ä¼˜åŒ–å‰ç«¯ JSON è§£æ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/components/Chat/ChatPanel.tsx`

```typescript
// åªåœ¨å®Œæˆ/å¤±è´¥æ—¶è§£æ
if (toolCall.status === 'completed' || toolCall.status === 'failed' || toolCall.result || toolCall.error) {
    try {
        parsedArguments = JSON.parse(argsStr);
    } catch (e) {
        // JSON ä¿®å¤é€»è¾‘
        parsedArguments = repairJSON(argsStr);
    }
} else {
    // è¿›è¡Œä¸­ï¼Œä¸è§£æ
    parsedArguments = {};
}
```

### è§£å†³æ–¹æ¡ˆ 3: æ·»åŠ ç½‘ç»œé‡è¯•æœºåˆ¶

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src-tauri/src/services/ai_providers/deepseek.rs`

```rust
// é‡è¯•æœºåˆ¶
for attempt in 0..3 {
    match self.client.post(...).send().await {
        Ok(resp) => {
            response = Some(resp);
            break;
        }
        Err(e) => {
            if attempt < 2 {
                let delay = Duration::from_millis(500 * (attempt + 1) as u64);
                tokio::time::sleep(delay).await;
            }
        }
    }
}
```

**ä¼˜åŒ– HTTP å®¢æˆ·ç«¯é…ç½®**ï¼š
```rust
let client = reqwest::Client::builder()
    .timeout(Duration::from_secs(120))
    .connect_timeout(Duration::from_secs(30))
    .tcp_keepalive(Duration::from_secs(30))
    .pool_max_idle_per_host(6)
    .http1_only()
    .build()?;
```

### è§£å†³æ–¹æ¡ˆ 4: æ·»åŠ è¯¦ç»†æ—¥å¿—

**åç«¯æ—¥å¿—**ï¼š
```rust
eprintln!("ğŸ“ ç´¯ç§¯å·¥å…·è°ƒç”¨ arguments: å½“å‰é•¿åº¦={}, æ–°å¢é•¿åº¦={}", 
    state_guard.2.len(), arguments.len());
eprintln!("ğŸ” æ£€æŸ¥ JSON å®Œæ•´æ€§: é•¿åº¦={}, å†…å®¹={}", args_str.len(), args_str);
eprintln!("âœ… JSON å®Œæ•´ï¼Œæ ‡è®°ä¸ºå®Œæˆ");
```

**å‰ç«¯æ—¥å¿—**ï¼š
```typescript
console.log('ğŸ”§ å¤„ç†å·¥å…·è°ƒç”¨:', {
    id: toolCallObj.id,
    name: toolCallObj.name,
    status: toolCallObj.status,
    argumentsLength: typeof toolCall.arguments === 'string' ? toolCall.arguments.length : 'object',
});
```

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

1. **`src-tauri/src/services/ai_providers/deepseek.rs`**
   - æµå¼å“åº”å¤„ç†
   - å·¥å…·è°ƒç”¨ arguments ç´¯ç§¯
   - JSON å®Œæ•´æ€§æ£€æµ‹

2. **`src-tauri/src/commands/ai_commands.rs`**
   - å·¥å…·è°ƒç”¨äº‹ä»¶å‘é€
   - å·¥å…·è°ƒç”¨æ‰§è¡Œ
   - çŠ¶æ€ç®¡ç†

3. **`src-tauri/src/services/tool_service.rs`**
   - å·¥å…·æ‰§è¡Œé€»è¾‘
   - æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
   - ç¼–è¾‘å™¨æ“ä½œ

4. **`src-tauri/src/services/tool_definitions.rs`**
   - å·¥å…·å®šä¹‰
   - å·¥å…·å‚æ•° schema

5. **`src-tauri/src/services/ai_providers/mod.rs`**
   - `ChatChunk` æšä¸¾å®šä¹‰
   - `ToolDefinition` ç»“æ„ä½“

### å‰ç«¯æ–‡ä»¶

1. **`src/components/Chat/ChatPanel.tsx`**
   - å·¥å…·è°ƒç”¨äº‹ä»¶ç›‘å¬
   - JSON è§£æå’Œä¿®å¤
   - çŠ¶æ€æ›´æ–°

2. **`src/components/Chat/ToolCallCard.tsx`**
   - å·¥å…·è°ƒç”¨ UI å±•ç¤º
   - å·¥å…·æ‰§è¡Œç¡®è®¤
   - Diff é¢„è§ˆ

3. **`src/stores/chatStore.ts`**
   - å·¥å…·è°ƒç”¨çŠ¶æ€ç®¡ç†
   - `addToolCall`ã€`updateToolCall` æ–¹æ³•

4. **`src/types/tool.ts`**
   - `ToolCall` æ¥å£å®šä¹‰
   - `ToolResult` æ¥å£å®šä¹‰
   - `ToolType` æšä¸¾

---

## è°ƒè¯•æŒ‡å—

### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

**åç«¯æ—¥å¿—**ï¼ˆè‡ªåŠ¨å¯ç”¨ï¼‰ï¼š
- `ğŸ“` - å‚æ•°ç´¯ç§¯æ—¥å¿—
- `ğŸ”` - JSON å®Œæ•´æ€§æ£€æŸ¥
- `âœ…` - æˆåŠŸæ“ä½œ
- `âŒ` - é”™è¯¯æ“ä½œ
- `â³` - è¿›è¡Œä¸­æ“ä½œ

**å‰ç«¯æ—¥å¿—**ï¼ˆæµè§ˆå™¨æ§åˆ¶å°ï¼‰ï¼š
- `ğŸ”§` - å·¥å…·è°ƒç”¨å¤„ç†
- `âš ï¸` - è­¦å‘Šä¿¡æ¯
- `âŒ` - é”™è¯¯ä¿¡æ¯

### 2. å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜ï¼šJSON è§£æå¤±è´¥

**æ£€æŸ¥ç‚¹**ï¼š
1. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤ `arguments` æ˜¯å¦å®Œæ•´ç´¯ç§¯
2. æŸ¥çœ‹å‰ç«¯æ—¥å¿—ï¼Œç¡®è®¤æ¥æ”¶åˆ°çš„ `arguments` å†…å®¹
3. æ£€æŸ¥ `status` æ˜¯å¦ä¸º `'completed'` æˆ– `'failed'`

**è°ƒè¯•å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
cd src-tauri && cargo run 2>&1 | grep -E "ğŸ“|ğŸ”|âœ…|âŒ"

# æŸ¥çœ‹å‰ç«¯æ—¥å¿—ï¼ˆæµè§ˆå™¨æ§åˆ¶å°ï¼‰
# è¿‡æ»¤å·¥å…·è°ƒç”¨ç›¸å…³æ—¥å¿—
```

#### é—®é¢˜ï¼šå·¥å…·è°ƒç”¨ç¼ºå°‘å‚æ•°

**æ£€æŸ¥ç‚¹**ï¼š
1. ç¡®è®¤ `arguments` JSON æ˜¯å¦å®Œæ•´
2. æ£€æŸ¥ JSON ä¿®å¤é€»è¾‘æ˜¯å¦ç”Ÿæ•ˆ
3. æŸ¥çœ‹æ­£åˆ™è¡¨è¾¾å¼æå–æ˜¯å¦æˆåŠŸ

**è°ƒè¯•ä»£ç **ï¼š
```typescript
// åœ¨ ChatPanel.tsx ä¸­æ·»åŠ 
console.log('åŸå§‹ arguments:', toolCall.arguments);
console.log('è§£æå arguments:', parsedArguments);
```

#### é—®é¢˜ï¼šç½‘ç»œè¿æ¥é”™è¯¯

**æ£€æŸ¥ç‚¹**ï¼š
1. ç¡®è®¤ API å¯†é’¥é…ç½®æ­£ç¡®
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æŸ¥çœ‹é‡è¯•æ—¥å¿—

**è°ƒè¯•å‘½ä»¤**ï¼š
```bash
# æµ‹è¯• API è¿æ¥
curl -X POST https://api.deepseek.com/v1/chat/completions \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model":"deepseek-chat","messages":[{"role":"user","content":"test"}]}'
```

### 3. æµ‹è¯•æµç¨‹

1. **å‘é€æ¶ˆæ¯è§¦å‘å·¥å…·è°ƒç”¨**
   ```
   ç”¨æˆ·: "åˆ›å»ºä¸€ä¸ª test.md æ–‡ä»¶"
   ```

2. **è§‚å¯Ÿåç«¯æ—¥å¿—**
   ```
   ğŸ“ ç´¯ç§¯å·¥å…·è°ƒç”¨ arguments: å½“å‰é•¿åº¦=0, æ–°å¢é•¿åº¦=10
   ğŸ“ ç´¯ç§¯åæ€»é•¿åº¦=10, å†…å®¹é¢„è§ˆ={"path"
   ğŸ” æ£€æŸ¥ JSON å®Œæ•´æ€§: é•¿åº¦=45, å†…å®¹={"path":"test.md","content":""}
   âœ… JSON å®Œæ•´ï¼Œæ ‡è®°ä¸ºå®Œæˆ
   âœ… å·¥å…·è°ƒç”¨å®Œæˆï¼Œå¼€å§‹å¤„ç†
   ğŸš€ å¼€å§‹æ‰§è¡Œå·¥å…·è°ƒç”¨: create_file
   âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸ: create_file
   ```

3. **è§‚å¯Ÿå‰ç«¯æ—¥å¿—**
   ```
   ğŸ”§ å¤„ç†å·¥å…·è°ƒç”¨: {id: "...", name: "create_file", status: "executing"}
   âœ… JSON ä¿®å¤æˆåŠŸ
   ğŸ”§ å¤„ç†å·¥å…·è°ƒç”¨: {id: "...", name: "create_file", status: "completed"}
   ```

4. **éªŒè¯ç»“æœ**
   - æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
   - æ£€æŸ¥å·¥å…·è°ƒç”¨çŠ¶æ€æ˜¯å¦æ­£ç¡®æ›´æ–°
   - æ£€æŸ¥ UI æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

---

## æœ€ä½³å®è·µ

### 1. å‚æ•°ç´¯ç§¯

- âœ… **ä½¿ç”¨ `push_str` ç´¯ç§¯**ï¼šåœ¨æµå¼å“åº”ä¸­ï¼Œä½¿ç”¨ `push_str` ç´¯ç§¯ `arguments`
- âœ… **æ£€æŸ¥å®Œæ•´æ€§**ï¼šåªåœ¨ JSON å®Œæ•´æ—¶æ ‡è®°ä¸º `is_complete: true`
- âœ… **çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨ `Arc<Mutex<>>` åœ¨å¼‚æ­¥æµä¸­ä¿æŒçŠ¶æ€

### 2. JSON è§£æ

- âœ… **å»¶è¿Ÿè§£æ**ï¼šåªåœ¨ `status === 'completed' || 'failed'` æ—¶è§£æ JSON
- âœ… **é”™è¯¯å¤„ç†**ï¼šå®ç° JSON ä¿®å¤é€»è¾‘å’Œåå¤‡æ–¹æ¡ˆ
- âœ… **æ—¥å¿—è®°å½•**ï¼šè®°å½•è§£æè¿‡ç¨‹å’Œé”™è¯¯ä¿¡æ¯

### 3. é”™è¯¯å¤„ç†

- âœ… **ç½‘ç»œé‡è¯•**ï¼šå®ç°æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
- âœ… **å‹å¥½æç¤º**ï¼šå‰ç«¯æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
- âœ… **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ä¾¿äºè°ƒè¯•

### 4. æ€§èƒ½ä¼˜åŒ–

- âœ… **å¼‚æ­¥æ‰§è¡Œ**ï¼šå·¥å…·è°ƒç”¨å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ UI
- âœ… **çŠ¶æ€æ›´æ–°**ï¼šä½¿ç”¨ Zustand è¿›è¡ŒçŠ¶æ€ç®¡ç†
- âœ… **äº‹ä»¶é©±åŠ¨**ï¼šä½¿ç”¨ Tauri äº‹ä»¶è¿›è¡Œå‰åç«¯é€šä¿¡

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æµå¼å¤„ç†**ï¼šä½¿ç”¨ `Arc<Mutex<>>` åœ¨å¼‚æ­¥æµä¸­ç´¯ç§¯å‚æ•°
2. **å®Œæ•´æ€§æ£€æµ‹**ï¼šæ£€æŸ¥ JSON å®Œæ•´æ€§åå†æ ‡è®°ä¸ºå®Œæˆ
3. **å»¶è¿Ÿè§£æ**ï¼šå‰ç«¯åªåœ¨å·¥å…·è°ƒç”¨å®Œæˆæ—¶è§£æ JSON
4. **é”™è¯¯æ¢å¤**ï¼šå®ç° JSON ä¿®å¤å’Œå‚æ•°æå–ä½œä¸ºåå¤‡æ–¹æ¡ˆ
5. **ç½‘ç»œä¼˜åŒ–**ï¼šæ·»åŠ é‡è¯•æœºåˆ¶å’Œä¼˜åŒ– HTTP å®¢æˆ·ç«¯é…ç½®

### å¾…ä¼˜åŒ–é¡¹

1. **JSON ä¿®å¤é€»è¾‘**ï¼šå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œæ”¯æŒæ›´å¤šé”™è¯¯æ¨¡å¼
2. **å‚æ•°éªŒè¯**ï¼šåœ¨å·¥å…·æ‰§è¡Œå‰éªŒè¯å‚æ•°å®Œæ•´æ€§
3. **å¹¶å‘æ§åˆ¶**ï¼šæ”¯æŒå¤šä¸ªå·¥å…·è°ƒç”¨å¹¶å‘æ‰§è¡Œ
4. **ç”¨æˆ·ç¡®è®¤**ï¼šå®ç°å·¥å…·è°ƒç”¨ç¡®è®¤æœºåˆ¶ï¼ˆDiff é¢„è§ˆï¼‰

### å‚è€ƒæ–‡æ¡£

- [DeepSeek API æ–‡æ¡£](https://api-docs.deepseek.com/)
- [Tauri äº‹ä»¶ç³»ç»Ÿ](https://tauri.app/v1/guides/features/events/)
- [Rust å¼‚æ­¥ç¼–ç¨‹](https://rust-lang.github.io/async-book/)
- [TypeScript JSON å¤„ç†](https://www.typescriptlang.org/docs/handbook/2/objects.html)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024-12-28  
**ç»´æŠ¤è€…**ï¼šBinder å¼€å‘å›¢é˜Ÿ

