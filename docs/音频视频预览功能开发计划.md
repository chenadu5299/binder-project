# 音频视频预览功能开发计划

## 文档信息

- **文档版本**：v1.0
- **创建日期**：2025年1月
- **文档性质**：开发计划
- **适用范围**：Binder 音频和视频文件预览功能 MVP 1.0
- **对应技术文档**：`音频视频预览功能技术方案.md`

---

## 一、开发目标

### 1.1 总体目标

**完成音频和视频文件的基础预览功能，支持主流格式的直接播放。**

**技术方案：**
- 使用 HTML5 Media API（`<audio>` 和 `<video>` 标签）
- 复用现有的 `read_file_as_base64` Tauri 命令
- 使用 Blob URL 方式加载文件（内存友好）

### 1.2 功能范围

**P0（必须实现，MVP 1.0）：**
- ✅ 音频预览（MP3、WAV、OGG、AAC、M4A）
- ✅ 视频预览（MP4、WebM、OGG）
- ✅ 基础播放控制（播放/暂停、进度条）
- ✅ 文件信息显示（文件名、文件大小）
- ✅ 基础错误处理

**P1（重要功能，尽量实现）：**
- 🔴 音量控制
- 🔴 播放速度控制
- 🔴 时长显示（加载后）
- 🔴 全屏功能（视频）
- 🔴 格式兼容性检测和友好提示

**P2（增强功能，后续版本）：**
- 🟡 部分支持格式的处理（FLAC、Opus、MOV）
- 🟡 大文件优化（> 50MB）
- 🟡 播放历史记录
- 🟡 格式转换功能（WMA、AVI、MKV、FLV、WMV）

---

## 二、开发阶段规划

### 2.1 Phase 1：基础功能（P0）

**目标：** 实现音频和视频文件的基础预览功能

**时间：** 3 天

**任务清单：**

#### Day 1：文件类型定义和识别

**任务1：扩展文件类型定义**
- **文件**：`src/types/file.ts`
- **修改内容**：
  - 在 `FileType` 类型中添加 `'audio'` 和 `'video'`
- **工作量**：0.5 天
- **负责人**：前端开发
- **验收标准**：类型定义正确，TypeScript 编译通过

**任务2：扩展文件类型识别**
- **文件**：`src/services/documentService.ts`
- **修改内容**：
  - 在 `getFileType` 函数中添加音频格式识别：`.mp3`, `.wav`, `.ogg`, `.aac`, `.m4a`
  - 在 `getFileType` 函数中添加视频格式识别：`.mp4`, `.webm`, `.ogg`
  - 在 `FILE_OPEN_STRATEGIES` 中添加 `audio` 和 `video` 的打开策略（预览模式，不可编辑）
- **工作量**：0.5 天
- **负责人**：前端开发
- **验收标准**：文件类型识别正确，打开策略配置正确

**任务3：扩展编辑器面板文件类型识别**
- **文件**：`src/components/Editor/EditorPanel.tsx`
- **修改内容**：
  - 在 `getFileType` 函数中添加音频和视频格式识别
- **工作量**：0.2 天
- **负责人**：前端开发
- **验收标准**：编辑器面板能正确识别音频和视频文件

**任务4：扩展文件树支持的文件类型**
- **文件**：`src/components/FileTree/FileTree.tsx`
- **修改内容**：
  - 在 `supportedTypes` 数组中添加音频扩展名：`'mp3', 'wav', 'ogg', 'aac', 'm4a'`
  - 在 `supportedTypes` 数组中添加视频扩展名：`'mp4', 'webm', 'ogg'`
- **工作量**：0.3 天
- **负责人**：前端开发
- **验收标准**：文件树中音频和视频文件可以点击打开

#### Day 2：MediaPreview 组件开发

**任务5：创建 MediaPreview 组件**
- **文件**：`src/components/Editor/MediaPreview.tsx`（新建）
- **功能要求**：
  - 接收 `filePath` 和 `fileType`（'audio' | 'video'）参数
  - 使用 `read_file_as_base64` 读取文件
  - 将 Base64 转换为 Blob URL
  - 根据 `fileType` 渲染 `<audio>` 或 `<video>` 标签
  - 实现基础播放控制（播放/暂停按钮、进度条）
  - 实现加载状态显示
  - 实现基础错误处理（文件加载失败提示）
  - 组件卸载时释放 Blob URL（`URL.revokeObjectURL`）
- **工作量**：1 天
- **负责人**：前端开发
- **验收标准**：
  - MP3 和 MP4 文件可以正常加载和播放
  - 播放/暂停功能正常
  - 进度条可以拖拽
  - 错误提示友好
  - 内存管理正确（无内存泄漏）

#### Day 3：集成和测试

**任务6：集成到编辑器面板**
- **文件**：`src/components/Editor/EditorPanel.tsx`
- **修改内容**：
  - 在文件渲染逻辑中添加音频和视频文件的处理
  - 当 `fileType === 'audio' || fileType === 'video'` 时，渲染 `MediaPreview` 组件
- **工作量**：0.3 天
- **负责人**：前端开发
- **验收标准**：音频和视频文件可以在编辑器中正常打开和预览

**任务7：功能测试**
- **测试内容**：
  - 音频格式测试：MP3、WAV、OGG、AAC、M4A 各一个文件
  - 视频格式测试：MP4、WebM、OGG 各一个文件
  - 播放控制测试：播放/暂停、进度条拖拽
  - 错误处理测试：损坏文件、不支持格式
  - 内存管理测试：打开多个文件，检查内存占用
- **工作量**：0.7 天
- **负责人**：测试工程师
- **验收标准**：
  - 所有支持的格式可以正常播放
  - 播放控制功能正常
  - 错误提示友好
  - 无内存泄漏

---

### 2.2 Phase 2：功能完善（P1）

**目标：** 完善播放控制功能和错误处理

**时间：** 2 天

**任务清单：**

#### Day 4：播放控制功能

**任务8：添加音量控制**
- **文件**：`src/components/Editor/MediaPreview.tsx`
- **功能要求**：
  - 添加音量滑块（0-100%）
  - 添加静音按钮
  - 音量状态持久化（可选，使用 localStorage）
- **工作量**：0.5 天
- **负责人**：前端开发
- **验收标准**：音量控制功能正常，静音功能正常

**任务9：添加播放速度控制**
- **文件**：`src/components/Editor/MediaPreview.tsx`
- **功能要求**：
  - 添加播放速度选择器（0.5x、0.75x、1x、1.25x、1.5x、2x）
  - 默认 1x
- **工作量**：0.3 天
- **负责人**：前端开发
- **验收标准**：播放速度控制功能正常

**任务10：添加文件信息显示**
- **文件**：`src/components/Editor/MediaPreview.tsx`
- **功能要求**：
  - 显示文件名
  - 显示文件大小（通过 Tauri 命令获取文件元数据）
  - 显示时长（加载完成后，通过媒体元素的 `duration` 属性获取）
  - 显示格式信息（从文件扩展名推断）
- **工作量**：0.5 天
- **负责人**：前端开发
- **验收标准**：文件信息显示准确，时长在加载完成后正确显示

**任务11：添加全屏功能（视频）**
- **文件**：`src/components/Editor/MediaPreview.tsx`
- **功能要求**：
  - 仅视频文件显示全屏按钮
  - 点击全屏按钮进入全屏模式
  - 支持 ESC 键退出全屏
- **工作量**：0.2 天
- **负责人**：前端开发
- **验收标准**：视频全屏功能正常，ESC 键可以退出全屏

#### Day 5：格式兼容性检测和错误处理

**任务12：实现格式兼容性检测**
- **文件**：`src/components/Editor/MediaPreview.tsx`
- **功能要求**：
  - 在文件加载前，使用 `canPlayType()` 检测浏览器是否支持该格式
  - 不支持的格式显示友好提示："此格式不支持，建议转换为 MP3/MP4 格式"
  - 部分支持的格式（FLAC、Opus、MOV）尝试加载，失败时提示
- **工作量**：0.5 天
- **负责人**：前端开发
- **验收标准**：
  - 不支持的格式提前提示
  - 部分支持的格式尝试加载，失败时提示
  - 提示信息友好

**任务13：完善错误处理**
- **文件**：`src/components/Editor/MediaPreview.tsx`
- **功能要求**：
  - 监听媒体元素的 `error` 事件
  - 根据错误类型显示不同的提示信息：
    - `MEDIA_ERR_ABORTED`：用户中止加载
    - `MEDIA_ERR_NETWORK`：网络错误
    - `MEDIA_ERR_DECODE`：解码错误（文件可能损坏）
    - `MEDIA_ERR_SRC_NOT_SUPPORTED`：格式不支持
  - 提供重试按钮（可选）
- **工作量**：0.5 天
- **负责人**：前端开发
- **验收标准**：错误处理完善，提示信息准确

**任务14：功能测试**
- **测试内容**：
  - 播放控制功能测试（音量、播放速度、全屏）
  - 文件信息显示测试
  - 格式兼容性检测测试（支持、部分支持、不支持格式）
  - 错误处理测试（损坏文件、网络错误模拟）
- **工作量**：0.5 天
- **负责人**：测试工程师
- **验收标准**：
  - 所有播放控制功能正常
  - 文件信息显示准确
  - 格式兼容性检测正确
  - 错误处理完善

---

### 2.3 Phase 3：优化和测试（可选）

**目标：** 优化性能和兼容性

**时间：** 1 天

**任务清单：**

#### Day 6：优化和测试

**任务15：大文件处理优化**
- **文件**：`src/components/Editor/MediaPreview.tsx`
- **功能要求**：
  - 添加文件大小检查（加载前）
  - 超过 50MB 的文件提示用户："文件较大，加载可能需要一些时间"
  - 超过 100MB 的文件提示用户："文件过大，建议使用其他工具打开"
- **工作量**：0.3 天
- **负责人**：前端开发
- **验收标准**：大文件处理合理，提示友好

**任务16：内存管理优化**
- **文件**：`src/components/Editor/MediaPreview.tsx`
- **功能要求**：
  - 确保组件卸载时释放 Blob URL
  - 切换标签页时暂停播放（可选）
  - 关闭标签页时释放资源
- **工作量**：0.2 天
- **负责人**：前端开发
- **验收标准**：内存管理正确，无内存泄漏

**任务17：兼容性测试**
- **测试内容**：
  - 部分支持格式测试：FLAC、Opus、MOV
  - 不同大小文件测试：小文件（< 10MB）、中等文件（10-50MB）、大文件（> 50MB）
  - 不同编码格式测试：MP4（H.264）、MP4（H.265，如果支持）
- **工作量**：0.5 天
- **负责人**：测试工程师
- **验收标准**：
  - 部分支持格式可以尝试加载
  - 不同大小文件处理合理
  - 兼容性良好

---

## 三、开发里程碑

### 3.1 Milestone 1：基础预览功能（Day 1-3）

**目标：** 完成音频和视频文件的基础预览功能

**交付物：**
- ✅ 文件类型定义和识别
- ✅ MediaPreview 组件
- ✅ 编辑器面板集成
- ✅ 基础播放控制功能

**验收标准：**
- MP3、WAV、OGG、AAC、M4A 音频文件可以正常播放
- MP4、WebM、OGG 视频文件可以正常播放
- 播放/暂停功能正常
- 进度条可以拖拽
- 错误提示友好
- 无内存泄漏

**时间：** Day 1-3（3 天）

### 3.2 Milestone 2：功能完善（Day 4-5）

**目标：** 完善播放控制功能和错误处理

**交付物：**
- ✅ 音量控制功能
- ✅ 播放速度控制功能
- ✅ 文件信息显示
- ✅ 全屏功能（视频）
- ✅ 格式兼容性检测
- ✅ 完善的错误处理

**验收标准：**
- 所有播放控制功能正常
- 文件信息显示准确
- 格式兼容性检测正确
- 错误处理完善

**时间：** Day 4-5（2 天）

### 3.3 Milestone 3：优化和测试（Day 6，可选）

**目标：** 优化性能和兼容性

**交付物：**
- ✅ 大文件处理优化
- ✅ 内存管理优化
- ✅ 兼容性测试报告

**验收标准：**
- 大文件处理合理
- 内存占用合理
- 兼容性良好

**时间：** Day 6（1 天，可选）

---

## 四、资源分配

### 4.1 人员配置

**前端开发：**
- 文件类型定义和识别：1 天
- MediaPreview 组件开发：1 天
- 播放控制功能：1 天
- 格式兼容性检测和错误处理：1 天
- 优化工作：0.5 天
- **P0 总计：3 天**
- **P1 总计：2 天**
- **优化总计：0.5 天**

**测试工程师：**
- 基础功能测试：0.7 天
- 功能完善测试：0.5 天
- 兼容性测试：0.5 天
- **总计：1.7 天**

### 4.2 时间安排

**Phase 1（P0）：** 3 天
- Day 1：文件类型定义和识别
- Day 2：MediaPreview 组件开发
- Day 3：集成和测试

**Phase 2（P1）：** 2 天
- Day 4：播放控制功能
- Day 5：格式兼容性检测和错误处理

**Phase 3（优化，可选）：** 1 天
- Day 6：优化和测试

**总计：** 5-6 天（约 1-1.5 周）

---

## 五、风险控制

### 5.1 技术风险

**风险1：大文件内存占用过高**
- **应对**：使用 Blob URL 而非 data URL，及时释放资源
- **降级方案**：限制文件大小（如 100MB），超过则提示用户

**风险2：部分格式兼容性不稳定**
- **应对**：使用 `canPlayType()` 提前检测，不支持的格式提前提示
- **降级方案**：部分支持的格式尝试加载，失败时提示用户转换

**风险3：Blob URL 内存泄漏**
- **应对**：确保组件卸载时调用 `URL.revokeObjectURL()`
- **降级方案**：使用 `useEffect` 清理函数确保资源释放

### 5.2 进度风险

**风险1：开发时间可能超出预期**
- **应对**：预留缓冲时间（20%）
- **降级方案**：优先实现 P0 功能，P1 功能可延期

**风险2：测试时间可能不足**
- **应对**：提前准备测试用例，并行测试
- **降级方案**：分阶段测试，确保核心功能稳定

### 5.3 质量风险

**风险1：格式兼容性可能不达标**
- **应对**：严格测试，确保主流格式（MP3、MP4）100% 支持
- **降级方案**：明确告知用户功能限制，提供格式转换建议

**风险2：性能可能不达标**
- **应对**：优化内存管理，添加文件大小限制
- **降级方案**：限制文件大小（如 100MB）

---

## 六、质量保证

### 6.1 测试计划

**功能测试：**
- 音频格式测试：MP3、WAV、OGG、AAC、M4A
- 视频格式测试：MP4、WebM、OGG
- 播放控制功能测试：播放/暂停、进度条、音量、播放速度、全屏
- 文件信息显示测试：文件名、文件大小、时长、格式
- 错误处理测试：损坏文件、不支持格式、网络错误

**兼容性测试：**
- 部分支持格式测试：FLAC、Opus、MOV
- 不同大小文件测试：小文件（< 10MB）、中等文件（10-50MB）、大文件（> 50MB）
- 不同编码格式测试：MP4（H.264）

**性能测试：**
- 加载时间测试：小文件即时加载，中等文件 < 5 秒
- 内存占用测试：打开多个文件，检查内存占用
- CPU 占用测试：播放时 < 20%

**用户体验测试：**
- 界面友好性测试
- 操作流畅性测试
- 错误提示友好性测试

### 6.2 验收标准

**功能验收：**
- ✅ 所有 P0 功能完整实现
- ✅ 功能符合技术方案文档
- ✅ 功能交互符合设计要求

**性能验收：**
- ✅ 小文件（< 10MB）即时加载
- ✅ 中等文件（10-50MB）加载时间 < 5 秒
- ✅ 内存占用合理（无内存泄漏）

**质量验收：**
- ✅ 无严重 Bug
- ✅ 错误处理完善
- ✅ 用户体验良好

---

## 七、交付清单

### 7.1 代码交付

**前端代码：**
- `src/types/file.ts`（扩展）
- `src/services/documentService.ts`（扩展）
- `src/components/Editor/EditorPanel.tsx`（扩展）
- `src/components/FileTree/FileTree.tsx`（扩展）
- `src/components/Editor/MediaPreview.tsx`（新建）

### 7.2 文档交付

**技术文档：**
- `音频视频预览功能技术方案.md`（已生成）

**开发文档：**
- `音频视频预览功能开发计划.md`（本文档）

### 7.3 测试交付

**测试用例：**
- 功能测试用例
- 兼容性测试用例
- 性能测试用例

**测试报告：**
- 功能测试报告
- 性能测试报告
- 兼容性测试报告

---

## 八、总结

### 8.1 开发计划特点

1. **分阶段实施**：P0 → P1 → 优化，逐步完善
2. **技术方案成熟**：使用浏览器原生 API，无需第三方库
3. **开发效率高**：复用现有文件读取机制，开发快速
4. **风险可控**：技术路线已验证，风险较低
5. **时间合理**：总计 5-6 天，符合 MVP 1.0 目标

### 8.2 关键成功因素

1. **技术方案成熟**：HTML5 Media API 是 W3C 标准，浏览器原生支持
2. **开发效率高**：复用现有 base64 文件读取机制，无需后端改动
3. **质量保证**：完善的测试计划和验收标准
4. **风险控制**：识别并应对潜在风险

### 8.3 后续规划

**MVP 1.0 完成后：**
- 收集用户反馈
- 优化预览体验
- 考虑添加格式转换功能（P2）
- 考虑添加播放列表功能（P2）

---

**文档版本**：v1.0  
**创建日期**：2025年1月  
**最后更新**：2025年1月  
**状态**：开发计划，待执行

