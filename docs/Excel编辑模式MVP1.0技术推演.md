# Excel 编辑模式 MVP 1.0 严格技术推演

## 一、MVP 1.0 功能范围（严格版）

### 1.1 核心功能（必须实现，技术风险低）

**P0 功能：**
- ✅ **Excel 预览模式**（PDF 转换）- 技术成熟，已有 DOCX 经验
- ✅ **单元格文本编辑** - 基础功能，技术简单
- ✅ **插入/删除行和列** - HTML 表格操作，技术简单
- ✅ **基础格式**（字体、颜色、对齐、边框、背景色）- 内联样式，技术简单
- ✅ **表头支持** - HTML `<th>` 标签，技术简单

### 1.2 重要功能（尽量实现，技术风险中）

**P1 功能：**
- ⚠️ **合并/拆分单元格** - HTML `rowspan`/`colspan`，技术中等
- ⚠️ **基础公式支持**（SUM, AVERAGE, IF）- 需要 ODS 解析，技术复杂

### 1.3 可选功能（技术风险高，MVP 1.0 暂不实现）

**P2 功能（移至后续版本）：**
- ❌ **多工作表支持** - 技术复杂，需要 ODS 多表解析
- ❌ **查找函数**（VLOOKUP）- 依赖多工作表，暂不支持
- ❌ **公式计算引擎** - 需要实现计算逻辑，工作量大
- ❌ **复杂嵌套公式** - 公式解析复杂，暂不支持

## 二、技术实现严格推演

### 2.1 预览模式（技术风险：低）

**技术路线：**
```
XLSX → LibreOffice → PDF → iframe 显示
```

**技术分析：**
- ✅ **LibreOffice 转换**：已有 DOCX → PDF 经验，技术成熟
- ✅ **PDF 显示**：使用 iframe + data URL，技术成熟
- ✅ **错误处理**：已有完善的错误处理机制
- ✅ **缓存机制**：已有缓存系统，可直接复用

**技术风险：低**
- LibreOffice Excel → PDF 转换稳定性：已验证（DOCX 已稳定）
- 转换时间：大文件可能较慢，但可接受
- 错误处理：已有完善的降级方案

**开发工作量：1-2 天**
- 复用现有 `preview_docx_as_pdf` 逻辑
- 创建 `ExcelPreview` 组件（复用 `DocxPdfPreview`）
- 文件类型识别扩展

**结论：✅ 完全可行，技术风险低**

### 2.2 编辑模式 - 基础功能（技术风险：中）

**技术路线：**
```
XLSX → LibreOffice → ODS → HTML表格 → TipTap编辑器 → HTML → ODS → XLSX
```

#### 2.2.1 Excel → HTML 转换

**技术方案A：LibreOffice 直接转换（推荐）**

```rust
// 使用 LibreOffice 将 XLSX 转换为 HTML
soffice --headless --convert-to html file.xlsx
```

**技术分析：**
- ✅ **LibreOffice 支持**：LibreOffice 原生支持 XLSX → HTML
- ⚠️ **HTML 格式**：LibreOffice 生成的 HTML 可能包含复杂样式
- ⚠️ **公式保留**：需要验证 LibreOffice HTML 输出是否保留公式

**技术风险：中**
- LibreOffice HTML 输出格式可能不标准
- 需要解析和清理 HTML，确保 TipTap 可以正确解析
- 公式保留需要验证

**验证点：**
1. LibreOffice 生成的 HTML 是否包含公式信息？
2. HTML 格式是否可以被 TipTap 正确解析？
3. 样式信息是否完整保留？

**技术方案B：ODS 中间格式（备选）**

```rust
// 1. XLSX → ODS
soffice --headless --convert-to ods file.xlsx

// 2. ODS → HTML（需要解析 ODS XML）
// ODS 是 ZIP 压缩的 XML，需要解析 content.xml
```

**技术分析：**
- ⚠️ **ODS 解析**：需要解析 ZIP + XML，技术复杂
- ⚠️ **公式提取**：需要从 XML 中提取公式信息
- ⚠️ **格式转换**：需要将 ODS 格式转换为 HTML 表格

**技术风险：高**
- ODS 解析工作量大
- XML 解析和格式转换复杂
- 需要处理各种边界情况

**结论：优先使用方案A（LibreOffice 直接转换），方案B 作为备选**

#### 2.2.2 HTML → Excel 转换

**技术方案：**
```rust
// 1. HTML → ODS（LibreOffice）
soffice --headless --convert-to ods file.html

// 2. ODS → XLSX（LibreOffice）
soffice --headless --convert-to xlsx file.ods
```

**技术分析：**
- ⚠️ **LibreOffice HTML 解析**：需要验证 LibreOffice 能否正确解析我们的 HTML
- ⚠️ **公式恢复**：需要验证 `data-formula` 属性是否能被 LibreOffice 识别
- ⚠️ **格式保留**：需要验证格式信息是否完整保留

**技术风险：高**
- LibreOffice 可能无法识别 `data-formula` 属性
- HTML → ODS 转换可能丢失格式
- 需要大量测试验证

**关键验证点：**
1. LibreOffice 能否识别 `data-formula` 属性？
2. 如果不能，需要什么格式才能保留公式？
3. HTML 表格格式是否会被正确转换？

**备选方案：直接操作 ODS**

如果 LibreOffice HTML 转换不稳定，考虑：
1. 编辑时：XLSX → ODS → 解析 ODS → HTML
2. 保存时：HTML → 解析并更新 ODS → XLSX

**技术风险：非常高**
- 需要完整的 ODS 解析和生成逻辑
- 工作量大，开发周期长
- 容易出错

**结论：需要先验证 LibreOffice HTML 转换的可行性**

### 2.3 公式支持（技术风险：高）

#### 2.3.1 公式保留技术分析

**关键问题：LibreOffice HTML 输出是否包含公式？**

**验证实验：**
1. 创建一个包含公式的 Excel 文件（如 `=SUM(A1:A10)`）
2. 使用 LibreOffice 转换为 HTML
3. 检查 HTML 是否包含公式信息

**可能的结果：**
- **情况A**：LibreOffice HTML 输出包含公式
  - 格式可能是：`<td formula="=SUM(A1:A10)">100</td>`
  - 技术风险：低，可以直接使用
- **情况B**：LibreOffice HTML 输出不包含公式
  - 只包含计算结果：`<td>100</td>`
  - 技术风险：高，需要从 ODS 提取公式

**如果情况B（公式丢失）：**

**技术方案：**
1. XLSX → ODS（保留公式）
2. 解析 ODS 提取公式信息
3. 生成 HTML 时添加 `data-formula` 属性

**技术复杂度：高**
- 需要解析 ODS XML
- 需要处理公式语法
- 需要维护公式和单元格的对应关系

**结论：需要先验证 LibreOffice HTML 转换是否保留公式**

#### 2.3.2 公式恢复技术分析

**关键问题：HTML → Excel 时如何恢复公式？**

**技术方案A：LibreOffice 识别 `data-formula`**

如果 LibreOffice 可以识别 `data-formula` 属性：
```html
<td data-formula="=SUM(A1:A10)">100</td>
```

**技术风险：低**（如果 LibreOffice 支持）

**技术方案B：ODS 直接操作**

如果 LibreOffice 不支持 `data-formula`，需要：
1. 解析 HTML，提取 `data-formula` 属性
2. 直接操作 ODS XML，写入公式
3. ODS → XLSX

**技术风险：非常高**
- 需要完整的 ODS 操作逻辑
- 需要处理公式语法和单元格引用
- 工作量大，容易出错

**结论：需要先验证 LibreOffice 对 `data-formula` 的支持**

### 2.4 合并单元格（技术风险：中）

**技术分析：**
- ✅ **HTML 支持**：`rowspan` 和 `colspan` 属性
- ✅ **TipTap 支持**：TipTap Table 扩展支持合并单元格
- ⚠️ **转换问题**：需要验证 LibreOffice 转换时是否正确保留合并信息

**技术风险：中**
- HTML 表格合并单元格技术成熟
- 需要验证 LibreOffice 转换的准确性

**结论：✅ 技术可行，需要验证转换准确性**

## 三、技术风险严格评估

### 3.1 高风险功能（MVP 1.0 暂不实现）

| 功能 | 技术风险 | 原因 | 建议 |
|------|---------|------|------|
| **公式支持** | 🔴 高 | LibreOffice HTML 转换可能不保留公式，需要 ODS 解析 | **MVP 1.0 暂不支持，移至 Phase 2** |
| **多工作表** | 🔴 高 | 需要 ODS 多表解析，技术复杂 | **MVP 1.0 暂不支持，移至 Phase 2** |
| **查找函数** | 🔴 高 | 依赖多工作表支持 | **MVP 1.0 暂不支持，移至 Phase 2** |
| **公式计算** | 🔴 高 | 需要实现计算引擎，工作量大 | **MVP 1.0 暂不支持，移至 Phase 2** |

### 3.2 中风险功能（需要验证）

| 功能 | 技术风险 | 验证点 | 建议 |
|------|---------|--------|------|
| **合并单元格** | 🟡 中 | LibreOffice 转换是否保留合并信息 | **MVP 1.0 支持，但需要验证** |
| **HTML → Excel 转换** | 🟡 中 | LibreOffice 能否正确解析我们的 HTML | **核心功能，必须验证** |
| **格式保留** | 🟡 中 | 格式信息是否完整保留 | **核心功能，必须验证** |

### 3.3 低风险功能（可以稳定实现）

| 功能 | 技术风险 | 原因 | 建议 |
|------|---------|------|------|
| **预览模式** | 🟢 低 | 已有 DOCX 经验，技术成熟 | **✅ MVP 1.0 必须实现** |
| **单元格编辑** | 🟢 低 | HTML 表格基础功能 | **✅ MVP 1.0 必须实现** |
| **插入/删除行列** | 🟢 低 | HTML 表格基础功能 | **✅ MVP 1.0 必须实现** |
| **基础格式** | 🟢 低 | 内联样式，技术简单 | **✅ MVP 1.0 必须实现** |

## 四、MVP 1.0 最终范围（严格版）

### 4.1 必须实现（技术风险低，稳定可行）

**核心功能：**
1. ✅ **Excel 预览模式**
   - XLSX → PDF 转换（复用 DOCX 逻辑）
   - PDF 预览显示（复用现有组件）
   - **技术风险：低，开发工作量：1-2 天**

2. ✅ **Excel 基础编辑模式**
   - XLSX → HTML 表格转换（LibreOffice）
   - HTML 表格在 TipTap 中编辑
   - HTML → XLSX 转换（LibreOffice）
   - **技术风险：中，开发工作量：3-5 天**

3. ✅ **单元格文本编辑**
   - 修改单元格内容
   - **技术风险：低，开发工作量：0.5 天**

4. ✅ **插入/删除行和列**
   - HTML 表格操作
   - **技术风险：低，开发工作量：1 天**

5. ✅ **基础格式**
   - 字体、颜色、对齐、边框、背景色
   - 内联样式实现
   - **技术风险：低，开发工作量：1-2 天**

6. ✅ **表头支持**
   - HTML `<th>` 标签
   - **技术风险：低，开发工作量：0.5 天**

### 4.2 尽量实现（技术风险中，需要验证）

**重要功能：**
1. ⚠️ **合并/拆分单元格**
   - HTML `rowspan`/`colspan`
   - 需要验证 LibreOffice 转换准确性
   - **技术风险：中，开发工作量：1-2 天**

### 4.3 暂不实现（技术风险高，移至后续版本）

**高级功能：**
1. ❌ **公式支持** - 移至 Phase 2
   - 需要验证 LibreOffice HTML 转换是否保留公式
   - 如果公式丢失，需要 ODS 解析（技术复杂）
   - **技术风险：高，开发工作量：5-10 天**

2. ❌ **多工作表支持** - 移至 Phase 2
   - 需要 ODS 多表解析
   - **技术风险：高，开发工作量：3-5 天**

3. ❌ **查找函数** - 移至 Phase 2
   - 依赖多工作表支持
   - **技术风险：高**

4. ❌ **公式计算引擎** - 移至 Phase 2
   - 需要实现计算逻辑
   - **技术风险：高，开发工作量：10-15 天**

## 五、技术验证计划

### 5.1 关键验证实验

**实验1：LibreOffice HTML 转换公式保留**
```
1. 创建测试 Excel 文件，包含公式：=SUM(A1:A10)
2. 使用 LibreOffice 转换为 HTML
3. 检查 HTML 是否包含公式信息
4. 如果包含，记录格式；如果不包含，评估 ODS 解析方案
```

**实验2：LibreOffice HTML → Excel 转换**
```
1. 创建包含 data-formula 属性的 HTML 表格
2. 使用 LibreOffice 转换为 XLSX
3. 检查公式是否恢复
4. 如果不支持，评估 ODS 直接操作方案
```

**实验3：合并单元格转换**
```
1. 创建包含合并单元格的 Excel 文件
2. 转换为 HTML，检查 rowspan/colspan 是否正确
3. HTML 转换回 Excel，检查合并是否保留
```

### 5.2 验证结果决策

**如果验证通过：**
- ✅ 公式支持可以加入 MVP 1.0
- ✅ 合并单元格可以加入 MVP 1.0

**如果验证失败：**
- ❌ 公式支持移至 Phase 2
- ⚠️ 合并单元格需要额外处理，评估是否加入 MVP 1.0

## 六、开发工作量估算（严格版）

### 6.1 MVP 1.0 核心功能

| 功能 | 开发工作量 | 技术风险 | 优先级 |
|------|-----------|---------|--------|
| Excel 预览模式 | 1-2 天 | 🟢 低 | P0 |
| Excel → HTML 转换 | 2-3 天 | 🟡 中 | P0 |
| HTML → Excel 转换 | 2-3 天 | 🟡 中 | P0 |
| 单元格编辑 | 0.5 天 | 🟢 低 | P0 |
| 插入/删除行列 | 1 天 | 🟢 低 | P0 |
| 基础格式 | 1-2 天 | 🟢 低 | P0 |
| 表头支持 | 0.5 天 | 🟢 低 | P0 |
| 合并单元格 | 1-2 天 | 🟡 中 | P1 |
| 测试和优化 | 2-3 天 | - | - |

**总计：10-17 天（约 2-3.5 周）**

### 6.2 如果加入公式支持（高风险）

| 功能 | 开发工作量 | 技术风险 | 优先级 |
|------|-----------|---------|--------|
| ODS 解析（如果需要） | 5-7 天 | 🔴 高 | - |
| 公式提取和保留 | 2-3 天 | 🔴 高 | - |
| 公式恢复 | 2-3 天 | 🔴 高 | - |
| 测试和优化 | 2-3 天 | - | - |

**额外工作量：11-16 天（约 2.5-3.5 周）**

**结论：公式支持工作量巨大，建议 MVP 1.0 暂不支持**

## 七、MVP 1.0 最终建议

### 7.1 推荐范围（稳定可行）

**必须实现：**
1. ✅ Excel 预览模式（PDF 转换）
2. ✅ Excel 基础编辑模式（HTML 表格）
3. ✅ 单元格文本编辑
4. ✅ 插入/删除行和列
5. ✅ 基础格式（字体、颜色、对齐、边框、背景色）
6. ✅ 表头支持

**尽量实现：**
1. ⚠️ 合并/拆分单元格（需要验证转换准确性）

**暂不实现：**
1. ❌ 公式支持（移至 Phase 2，需要先验证技术可行性）
2. ❌ 多工作表支持（移至 Phase 2）
3. ❌ 查找函数（移至 Phase 2）
4. ❌ 公式计算引擎（移至 Phase 2）

### 7.2 实施步骤

**Phase 1：技术验证（1-2 天）**
1. 验证 LibreOffice HTML 转换是否保留公式
2. 验证 LibreOffice HTML → Excel 转换可行性
3. 验证合并单元格转换准确性

**Phase 2：核心功能开发（8-12 天）**
1. Excel 预览模式（1-2 天）
2. Excel → HTML 转换（2-3 天）
3. HTML → Excel 转换（2-3 天）
4. 基础编辑功能（3-4 天）

**Phase 3：测试和优化（2-3 天）**
1. 功能测试
2. 边界情况处理
3. 错误处理优化

**总计：11-17 天（约 2.5-3.5 周）**

### 7.3 风险控制

**技术风险：**
- 核心功能技术风险：中低
- 公式支持技术风险：高（暂不支持）
- 合并单元格技术风险：中（需要验证）

**稳定性保障：**
1. 先实现预览模式（技术成熟）
2. 再实现基础编辑（逐步验证）
3. 公式支持需要先验证技术可行性
4. 明确告知用户功能限制

**用户提示：**
```
⚠️ Excel 编辑模式（MVP 1.0）：
- ✅ 支持：单元格编辑、行列操作、基础格式、合并单元格
- ❌ 不支持：公式、多工作表、图表、数据透视表

如需完整功能，请使用 Excel 或其他专业工具。
```

## 八、结论

### 8.1 落地性评估

**结论：✅ MVP 1.0 可以稳定落地**

**理由：**
1. ✅ 核心功能技术风险低（预览模式、基础编辑）
2. ✅ 已有 DOCX 经验，可以复用
3. ✅ 开发工作量可控（2-3.5 周）
4. ✅ 功能范围聚焦，避免过度复杂

### 8.2 关键成功因素

1. **技术验证先行**：先验证 LibreOffice 转换可行性
2. **功能聚焦**：暂不支持公式，确保核心功能稳定
3. **逐步迭代**：MVP 1.0 聚焦基础功能，后续版本逐步增强
4. **明确限制**：清楚告知用户功能范围

### 8.3 后续规划

**Phase 2（公式支持）：**
- 先验证技术可行性
- 如果可行，实现基础公式支持
- 如果不可行，评估替代方案

**Phase 3（多工作表）：**
- 在公式支持稳定后，再考虑多工作表

---

**文档版本**：v1.0  
**创建日期**：2025-01-XX  
**状态**：严格技术推演，待评审

