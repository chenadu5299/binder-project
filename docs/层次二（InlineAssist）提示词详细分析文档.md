# 层次二（Inline Assist）提示词详细分析文档

## 文档信息

- **文档版本**：v1.0
- **创建日期**：2025年
- **文档性质**：提示词工程分析文档
- **适用范围**：Binder 层次二（Inline Assist）功能提示词优化

## 格式说明

**重要**：本文档中提到的文档格式说明：
- **原生 DOCX**：Word 原生的 .docx 文件，Binder 只能预览，不能编辑
- **t-docx**：Binder 可编辑的文档格式（TipTap 模拟的 DOCX），包括：
  - Binder 生成的文档
  - 从预览模式切换到编辑模式时创建的草稿文件（如 `document.draft.docx`）
  - 所有在 Binder 编辑器中可编辑的文档

本文档中所有涉及"可编辑"、"格式匹配"、"样式继承"等场景下的 DOCX，均指 **t-docx** 格式。

---

## 一、当前提示词设计回顾

### 1.1 当前提示词结构

```
[系统提示词]
你是一个专业的文档编辑助手，帮助用户修改文本内容。

[上下文内容]
[选中文本前后的内容（各 500 字符）]

[用户指令]
[用户输入的指令，如："改得更正式"、"翻译成英文"等]

[选中文本]
[用户选中的文本（如果有）]

[任务要求]
对以下文本执行指令：[用户指令]
```

### 1.2 当前设计的优点

- **角色定位清晰**：明确为"文档编辑助手"
- **上下文充足**：前后各 500 字符基本能覆盖段落上下文
- **指令明确**：直接使用用户输入的指令

### 1.3 当前设计的不足

- **功能定位过窄**：仅定位为"修改文本内容"，但层次二实际支持分析、讨论、匹配等多种需求
- **指令类型未区分**：未根据指令类型（改写/续写/分析/讨论）调整提示词
- **无选中文本场景缺失**：未考虑用户无选中文本直接对话的场景
- **指令理解不足**：模糊指令（如"改好一点"）的处理机制不明确
- **格式限制过严**：在列表、代码块等场景中格式限制不合理

---

## 二、层次二功能特性分析

### 2.1 核心特性

**指令驱动**：
- 用户通过指令明确表达需求
- 指令类型多样：改写、续写、分析、讨论、匹配等
- 需要根据指令类型动态调整处理方式

**灵活交互**：
- 可以有选中文本（修改、分析选中内容）
- 可以无选中文本（直接对话、生成内容）
- 支持多种操作模式

### 2.2 指令类型分类

#### 2.2.1 文本修改类

**典型指令**：
- "改得更正式"、"改得更简洁"、"改得更专业"
- "翻译成英文"、"翻译成中文"
- "改成被动语态"、"改成第一人称"
- "润色一下"、"优化表达"

**需求特点**：
- 需要理解选中文本的语义
- 需要保持语义不变，只改变表达方式
- 需要匹配文档格式和样式

**当前提示词问题**：
- ❌ 模糊指令（如"改好一点"）无法准确理解
- ❌ 可能破坏原文的语义或逻辑
- ❌ 格式转换指令（如"转换为 Markdown"）处理不明确

#### 2.2.2 内容生成类

**典型指令**：
- "续写一段"、"补充说明"、"添加例子"
- "生成摘要"、"生成标题"
- "写一个开头"、"写一个结尾"

**需求特点**：
- 需要理解上下文语义
- 需要保持风格一致性
- 需要匹配文档格式

**当前提示词问题**：
- ❌ 续写方向不明确（推进/补充/转折）
- ❌ 可能破坏文档结构
- ❌ 风格一致性难以保证

#### 2.2.3 分析讨论类

**典型指令**：
- "分析这段文字"、"这段文字的问题是什么"
- "讨论这个观点"、"评价这个方案"
- "解释这个概念"、"说明这个原理"

**需求特点**：
- 不需要修改文本，只需要分析或讨论
- 输出可能是分析结果、评价、解释等
- 可能需要引用外部知识

**当前提示词问题**：
- ❌ 当前提示词定位为"修改文本"，不适合分析讨论场景
- ❌ 分析结果可能以文本形式返回，需要明确输出格式
- ❌ 未考虑是否需要引用外部信息

#### 2.2.4 匹配查找类

**典型指令**：
- "查找类似的表达"、"匹配相关概念"
- "找到对应的段落"、"关联相关内容"
- "检查一致性"、"验证准确性"

**需求特点**：
- 需要搜索或匹配文档中的相关内容
- 可能需要跨文档查找
- 输出可能是匹配结果、关联内容等

**当前提示词问题**：
- ❌ 当前提示词不支持搜索和匹配功能
- ❌ 未考虑跨文档查找的需求
- ❌ 匹配结果的展示方式不明确

### 2.3 无选中文本场景

**典型场景**：
- 用户直接输入指令，无选中文本
- 指令可能是："生成一段介绍"、"写一个开头"、"分析当前文档"
- 需要基于光标位置或整个文档上下文

**当前提示词问题**：
- ❌ 提示词结构假设必须有选中文本
- ❌ 无选中文本时上下文提取规则不明确
- ❌ 指令处理方式未区分有/无选中文本

---

## 三、提示词优化建议

### 3.1 系统提示词优化

**当前**：
```
你是一个专业的文档编辑助手，帮助用户修改文本内容。
```

**优化后**：
```
你是一个专业的文档编辑助手，可以根据用户指令执行多种操作：
- 文本修改：改写、润色、翻译、格式转换等
- 内容生成：续写、补充、生成摘要等
- 分析讨论：分析文本、讨论观点、解释概念等
- 匹配查找：查找相关内容、匹配概念、检查一致性等

请根据用户指令的类型，选择合适的方式处理。
```

### 3.2 指令类型识别

**建议**：
```
[指令分析]
用户指令：[用户输入的指令]
指令类型：[自动识别：修改/生成/分析/匹配]
处理方式：[根据指令类型确定处理方式]

- 如果指令类型为"修改"：修改选中文本，保持语义不变
- 如果指令类型为"生成"：生成新内容，匹配上下文风格
- 如果指令类型为"分析"：分析选中文本或当前文档，输出分析结果
- 如果指令类型为"匹配"：查找或匹配相关内容，输出匹配结果
```

### 3.3 上下文提取优化

**有选中文本**：
```
[上下文内容]
选中文本：[用户选中的文本]
上下文（前 500 字符）：[选中文本前 500 字符]
上下文（后 500 字符）：[选中文本后 500 字符]
```

**无选中文本**：
```
[上下文内容]
光标位置上下文（前 500 字符）：[光标前 500 字符]
光标位置上下文（后 500 字符）：[光标后 500 字符]
文档整体信息：[文档主题、结构等]（如需要）
```

### 3.4 格式适配优化

**动态格式要求**：
```
[格式信息]
当前文档格式：[TXT/t-docx/Markdown/HTML]
当前位置格式：[段落/列表/表格/代码块等]

格式要求：
- 如果指令要求格式转换（如"转换为 Markdown"），按指令执行
- 否则，保持当前文档格式：
  - TXT 格式：纯文本，无格式标记
  - Markdown 格式：允许 Markdown 语法，与上下文风格一致
  - t-docx 格式：匹配 t-docx 样式，保持格式一致性
  - HTML 格式：允许 HTML 标签，与上下文风格一致
- 如果上下文在列表中，输出应保持列表格式
- 如果上下文在代码块中，输出应保持代码格式（技术文档）
```

### 3.5 模糊指令处理

**建议**：
```
[指令理解]
如果用户指令不明确（如"改好一点"、"优化一下"），请：
1. 分析上下文，推断用户的合理意图
2. 基于上下文风格和内容特点，执行合理的优化
3. 如果无法推断，可以询问用户具体需求（分析讨论场景）
```

### 3.6 分析讨论场景优化

**建议**：
```
[分析讨论要求]
如果指令类型为"分析"或"讨论"：
- 输出分析结果、评价、解释等，不需要修改原文
- 可以引用外部知识（如需要）
- 输出格式可以是纯文本或格式化文本（根据指令决定）
- 保持客观、专业的分析风格
```

---

## 四、优化后的提示词结构

### 4.1 完整提示词结构

```
[系统提示词]
你是一个专业的文档编辑助手，可以根据用户指令执行多种操作：
- 文本修改：改写、润色、翻译、格式转换等
- 内容生成：续写、补充、生成摘要等
- 分析讨论：分析文本、讨论观点、解释概念等
- 匹配查找：查找相关内容、匹配概念、检查一致性等

[文档格式信息]
当前文档格式：[格式类型]
格式要求：[根据格式类型和指令动态生成]

[上下文内容]
[根据是否有选中文本动态构建]

[用户指令]
[用户输入的指令]

[指令分析]
指令类型：[修改/生成/分析/匹配]
处理方式：[根据指令类型确定]

[任务要求]
根据指令类型执行相应操作：
- 修改：修改文本，保持语义不变，匹配格式和样式
- 生成：生成内容，匹配上下文风格和格式
- 分析：分析文本，输出分析结果，保持客观专业
- 匹配：查找匹配内容，输出匹配结果
```

### 4.2 场景示例

#### 4.2.1 文本修改场景

```
指令："改得更正式"
指令类型：修改
处理方式：改写选中文本，使其更正式，保持语义不变
```

#### 4.2.2 内容生成场景

```
指令："续写一段"
指令类型：生成
处理方式：基于上下文续写内容，匹配风格和格式
```

#### 4.2.3 分析讨论场景

```
指令："分析这段文字的问题"
指令类型：分析
处理方式：分析选中文本，输出问题分析结果，不修改原文
```

#### 4.2.4 无选中文本场景

```
指令："生成一段介绍"
指令类型：生成
处理方式：基于光标位置上下文生成介绍内容
```

---

## 五、技术实现要点

### 5.1 指令类型识别

**实现方式**：
- 使用关键词匹配识别指令类型
- 使用大语言模型分析指令意图
- 根据指令类型动态调整提示词

### 5.2 上下文提取

**有选中文本**：
- 提取选中文本前后各 500 字符
- 识别选中文本的格式和样式

**无选中文本**：
- 提取光标前后各 500 字符
- 可选：提取文档整体信息（主题、结构等）

### 5.3 格式适配

**动态判断**：
- 识别当前文档格式
- 识别当前位置格式（段落/列表/代码块等）
- 根据指令要求动态调整格式约束

### 5.4 输出处理

**根据指令类型**：
- 修改类：返回修改后的文本，显示 Diff 视图
- 生成类：返回生成的内容，直接插入或显示预览
- 分析类：返回分析结果，以文本形式展示
- 匹配类：返回匹配结果，以列表或文本形式展示

---

## 六、优化优先级

### 6.1 P0 优先级（必须实现）

- ✅ **指令类型识别**：区分修改/生成/分析/匹配
- ✅ **无选中文本支持**：支持无选中文本的场景
- ✅ **格式适配优化**：根据文档格式和场景动态调整
- ✅ **模糊指令处理**：基于上下文推断合理意图

### 6.2 P1 优先级（建议实现）

- ⚠️ **上下文增强**：增加文档整体信息（主题、结构）
- ⚠️ **风格识别**：识别文档风格，保持一致性
- ⚠️ **语义分析**：提取关键实体、主题，提升理解准确性

### 6.3 P2 优先级（可选实现）

- 📋 **跨文档匹配**：支持跨文档查找和匹配
- 📋 **外部知识引用**：分析讨论场景引用外部知识
- 📋 **用户偏好学习**：学习用户的指令偏好

---

## 七、总结

### 7.1 核心优化点

1. **功能定位扩展**：从"修改文本"扩展到"多种操作"（修改/生成/分析/匹配）
2. **指令类型识别**：根据指令类型动态调整处理方式
3. **无选中文本支持**：支持无选中文本直接对话的场景
4. **格式适配优化**：根据文档格式和场景动态调整格式要求
5. **模糊指令处理**：基于上下文推断合理意图

### 7.2 实施建议

**第一阶段（P0）**：
- 实现指令类型识别
- 支持无选中文本场景
- 优化格式适配
- 处理模糊指令

**第二阶段（P1）**：
- 增强上下文信息
- 实现风格识别
- 优化语义分析

**第三阶段（P2）**：
- 支持跨文档匹配
- 引用外部知识
- 用户偏好学习

---

**文档版本**：v1.0  
**创建日期**：2025年  
**最后更新**：2025年  
**维护者**：Binder 开发团队

