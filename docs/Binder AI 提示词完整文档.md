# Binder AI 提示词完整文档

## 文档信息

- **文档版本**：v1.0
- **创建日期**：2025年
- **最后更新**：2025年
- **文档性质**：提示词设计和使用文档
- **适用范围**：Binder 应用的所有 AI 功能提示词

## 格式说明

**重要**：本文档中提到的文档格式说明：
- **原生 DOCX**：Word 原生的 .docx 文件，Binder 只能预览，不能编辑
- **t-docx**：Binder 可编辑的文档格式（TipTap 模拟的 DOCX），包括：
  - Binder 生成的文档
  - 从预览模式切换到编辑模式时创建的草稿文件（如 `document.draft.docx`）
  - 所有在 Binder 编辑器中可编辑的文档

本文档中所有涉及"可编辑"、"格式匹配"、"样式继承"等场景下的 DOCX，均指 **t-docx** 格式。

---

## 一、提示词架构概述

### 1.1 多层提示词架构

Binder 的 AI 功能采用**多层提示词架构**，根据不同功能层次和场景动态构建提示词：

```
┌─────────────────────────────────────┐
│  第一层：基础系统提示词              │
│  - 角色定义                          │
│  - 基本行为规范                      │
│  - 工作规划要求（Agent 模式）        │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  第二层：上下文提示词                │
│  - 当前文档信息                      │
│  - 编辑器状态                        │
│  - 工作区信息                        │
│  - 文档格式和样式信息                │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  第三层：引用提示词                  │
│  - 用户引用的内容                    │
│  - 引用类型和来源                    │
│  - 引用内容完整传递                  │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  第四层：工具调用提示词（Agent模式） │
│  - 工具调用规范                      │
│  - 工具使用说明                      │
│  - JSON 格式要求                    │
└─────────────────────────────────────┘
```

### 1.2 提示词构建逻辑

**构建时机**：
- 层次一（自动补全）：每次触发时构建
- 层次二（Inline Assist）：用户提交指令时构建
- 层次三（聊天窗口）：每次发送消息时构建

**构建位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs`
- 提示词构建函数：根据功能类型调用不同的构建逻辑

---

## 二、层次一：自动补全提示词

### 2.1 提示词结构

**完整结构**：
```
[系统提示词]
你是一个写作助手，帮助用户续写内容。

[文档格式信息]
当前文档格式：[格式类型]（.txt、.t-docx、.md、.html 等）
格式要求：[格式要求说明]

[上下文内容]
[光标前 300 字符的文档内容，优先在段落边界截断]

[续写要求]
基于以上上下文，续写接下来的内容（50-100 字，以完整句子结尾）：
- 保持与上下文风格一致（语气、专业度、叙述方式）
- 匹配当前文档格式和样式
- 续写内容应为普通段落文本，不使用 Markdown 标记、列表符号或代码块
```

### 2.2 系统提示词

**内容**：
```
你是一个写作助手，帮助用户续写内容。
```

**工作逻辑**：
- 在每次 AI 调用时作为第一条系统消息
- 明确 AI 的角色和任务
- 简洁明了，不包含过多约束

**保存位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_autocomplete`
- 硬编码在函数中，当前未提取为配置文件

### 2.3 文档格式信息提示词

**内容**：
```
当前文档格式：[格式类型]（.txt、.t-docx、.md、.html 等）
格式要求：
- TXT 格式：生成纯文本，无格式标记
- t-docx 格式：生成内容需匹配 t-docx 样式（如段落样式、文本样式），保持与上下文一致的格式
- Markdown 格式：生成内容可包含 Markdown 语法（如粗体、斜体），但需与上下文风格一致
- HTML 格式：生成内容可包含 HTML 标签，但需与上下文风格一致
```

**工作逻辑**：
- 从编辑器获取当前文档格式（文件扩展名）
- 根据格式类型动态生成格式要求说明
- 在系统提示词后添加格式信息

**保存位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_autocomplete`
- 格式要求模板：硬编码在函数中

### 2.4 上下文内容提示词

**内容**：
```
[光标前 300 字符的文档内容，优先在段落边界截断]
```

**工作逻辑**：
- 提取光标前 300 字符的文档内容（动态调整：300-500 字符）
- 优先在段落边界截断，保持上下文完整性
- 最小要求：至少 50 字符
- 如果内容不足，不触发自动补全
- 作为用户消息的一部分传递给 AI

**保存位置**：
- 前端：`src/hooks/useAutoComplete.ts` - 提取上下文
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_autocomplete` - 接收上下文

### 2.5 续写要求提示词

**内容**：
```
基于以上上下文，续写接下来的内容（50-100 字，以完整句子结尾）：
- 保持与上下文风格一致（语气、专业度、叙述方式）
- 匹配当前文档格式和样式
- 续写内容应为普通段落文本，不使用 Markdown 标记、列表符号或代码块
```

**工作逻辑**：
- 作为用户消息的一部分
- 明确续写要求和限制
- 强调格式和样式匹配

**保存位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_autocomplete`
- 硬编码在函数中

---

## 三、层次二：Inline Assist 提示词

### 3.1 提示词结构

**完整结构**：
```
[系统提示词]
你是一个专业的文档编辑助手，帮助用户修改文本内容。

[文档格式信息]
当前文档格式：[格式类型]
格式要求：[格式要求说明]

[任务指令]
对选中文本「[选中文本]」执行操作：[用户指令]

[上下文内容]
上下文（前 500 字符）：[选中文本前 500 字符]
上下文（后 500 字符）：[选中文本后 500 字符]

[任务要求]
- 保持与上下文风格一致
- 匹配当前文档格式和样式
- 如果指令要求格式转换，按指令执行；否则保持当前格式
- 如果指令不明确（如"改好一点"、"更专业"），请基于上下文推断合理意图并执行
```

### 3.2 系统提示词

**内容**：
```
你是一个专业的文档编辑助手，帮助用户修改文本内容。
```

**工作逻辑**：
- 在每次 AI 调用时作为第一条系统消息
- 明确 AI 的角色和任务
- 强调"修改文本内容"的定位

**保存位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_inline_assist`
- 硬编码在函数中

### 3.3 文档格式信息提示词

**内容**：
```
当前文档格式：[格式类型]
格式要求：
- TXT 格式：修改后的内容保持纯文本格式，无格式标记
- t-docx 格式：修改后的内容需匹配 t-docx 样式（标题、粗体、斜体、列表、段落对齐等），保持与选中文本一致的格式
- Markdown 格式：修改后的内容可包含 Markdown 语法，保持与上下文风格一致
- HTML 格式：修改后的内容可包含 HTML 标签，保持与上下文风格一致
```

**工作逻辑**：
- 从编辑器获取当前文档格式
- 根据格式类型动态生成格式要求说明
- 强调保持格式一致性

**保存位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_inline_assist`
- 格式要求模板：硬编码在函数中

### 3.4 上下文内容提示词

**内容**：
```
[选中文本前后的内容（各 500 字符）]
```

**工作逻辑**：
- 如果有选中文本：提取选中文本前后各 500 字符
- 如果无选中文本：提取光标位置前后各 500 字符
- 优先选择与选中文本相关的内容
- 作为用户消息的一部分传递给 AI

**保存位置**：
- 前端：`src/hooks/useInlineAssist.ts` - 提取上下文
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_inline_assist` - 接收上下文

### 3.5 用户指令提示词

**内容**：
```
[用户输入的指令，如："改得更正式"、"翻译成英文"等]
```

**工作逻辑**：
- 直接使用用户输入的指令
- 作为用户消息的一部分
- 不进行额外处理

**保存位置**：
- 前端：`src/hooks/useInlineAssist.ts` - 获取用户输入
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_inline_assist` - 接收指令

### 3.6 任务要求提示词

**内容**：
```
对选中文本「[选中文本]」执行操作：[用户指令]

任务要求：
- 保持与上下文风格一致
- 匹配当前文档格式和样式
- 如果指令要求格式转换，按指令执行；否则保持当前格式
- 如果指令不明确（如"改好一点"、"更专业"），请基于上下文推断合理意图并执行
```

**工作逻辑**：
- 作为用户消息的一部分
- 明确任务要求和限制
- 强调格式和样式匹配

**保存位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_inline_assist`
- 硬编码在函数中

---

## 四、层次三：聊天窗口提示词

### 4.1 多层提示词架构

层次三采用**四层提示词架构**，根据聊天模式和上下文动态构建。

### 4.2 第一层：基础系统提示词

#### 4.2.1 Chat 模式系统提示词

**内容**：
```
你是一个专业的编程助手和文档编辑助手。
你可以帮助用户：
- 回答编程和文档相关的问题
- 提供技术建议和最佳实践
- 分析和讨论代码和文档内容
- 提供格式化和样式建议

请以友好、专业的方式回答用户的问题。
```

**工作逻辑**：
- 在 Chat 模式下使用
- 作为第一条系统消息
- 明确 AI 的角色和能力范围
- 不包含工具调用相关的内容

**保存位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream`
- 当前实现：如果消息列表中没有系统消息，会添加默认系统提示词
- 建议：提取为配置文件 `src-tauri/src/config/prompts/chat_system_prompt.txt`

#### 4.2.2 Agent 模式系统提示词

**内容**：
```
你是一个专业的编程助手和文档编辑助手。

你可以帮助用户：
- 回答编程和文档相关的问题
- 执行文件操作（读取、创建、更新、删除文件等）
- 执行编辑器操作（修改文档内容等）
- 搜索和浏览网络信息（如需要外部信息）

工作模式：
你可以访问以下工具：[工具列表]

执行流程：
1. **判断是否需要规划**：
   - 如果任务需要读取多个文件（3个以上）或浏览网站，先调用 `plan_workflow` 工具生成规划
   - 对于简单任务（读取1-2个文件、修改文档等），直接调用相关工具
   - 规划生成后会展示给用户确认，确认后继续执行

2. **何时需要规划**：
   - ✅ "帮我分析项目中所有配置文件的差异" → 需要规划
   - ❌ "读取 config.json 并解释其作用" → 直接执行
   - ✅ "根据 requirements.txt 创建项目文档" → 需要规划（涉及多步骤）

3. **工具调用格式要求（CRITICAL）**：
   所有工具调用必须使用严格的 JSON 格式：
   ```json
   {"tool":"tool_name","arguments":{"key":"value"}}
   ```
   
   常见错误：
   - ❌ `{tool:read_file,arguments:{path:test.md}}`  // 缺少引号
   - ❌ `{"tool":"read_file","arguments":{"path":test.md}}`  // 值缺少引号
   - ✅ `{"tool":"read_file","arguments":{"path":"test.md"}}`
   
   规则：
   - 所有键名必须用双引号包裹
   - 所有字符串值必须用双引号包裹
   - JSON 必须完整闭合，以 } 结尾
   - 确保 JSON 格式完全正确，可以被 JSON.parse() 解析
```

**工作逻辑**：
- 在 Agent 模式下使用
- 作为第一条系统消息
- 包含工作模式说明、执行流程和工具调用规范
- JSON 格式要求统一在系统提示词末尾，不再重复添加

**保存位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream`
- 当前实现：硬编码在函数中（第 221-223 行和第 227-230 行）
- 建议：提取为配置文件 `src-tauri/src/config/prompts/agent_system_prompt.txt`

### 4.3 第二层：上下文提示词

#### 4.3.1 当前文档信息提示词

**内容**：
```
[当前打开的文档]
文件路径：[文件路径]
文档内容预览：
[智能选择 1000 字符的文档内容]

文档内容预览选择规则（智能选择）：
- 如果用户消息提到文档某部分（如"第三章"、"开头部分"），优先包含该部分
- 如果用户询问整体问题（如"总结文档"、"文档主题"），包含文档开头 + 结构大纲
- 如果用户追问具体细节，包含光标位置附近内容（前后各 400 字符）
- 如果文档有标题结构，优先包含当前段落所在章节的内容
- 如果光标位置内容不足，补充文档开头内容
```

**工作逻辑**：
- 检测当前是否有打开的文档
- 如果有，提取文档信息（路径、内容预览）
- 智能选择关键内容（光标附近、章节内容）
- 作为系统消息的一部分添加到消息列表

**保存位置**：
- 前端：`src/components/Chat/ChatPanel.tsx` - 构建上下文
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream` - 接收上下文

#### 4.3.2 编辑器状态信息提示词

**内容**：
```
[当前编辑器状态]
- 是否可编辑：[只读/可编辑]
- 文件类型：[.md、.t-docx、.html 等]
- 文件大小：[文件大小]（如果 > 1MB，提示"大文件"）
- 是否已保存：[已保存/有未保存更改]

[文档格式和样式信息]
- 当前文档格式：[.txt、.t-docx、.md、.html 等]
- 当前光标位置的样式信息：[段落样式、文本样式等]（如 t-docx）
- 选中文本的样式信息：[样式信息]（如有选中文本）

格式匹配要求：
生成内容需匹配当前 [格式] 的样式规范，保持与文档一致的格式和风格。
```

**工作逻辑**：
- 从编辑器获取状态信息
- 获取格式和样式信息
- 生成格式匹配要求说明
- 作为系统消息的一部分

**保存位置**：
- 前端：`src/components/Chat/ChatPanel.tsx` - 获取编辑器状态
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream` - 接收状态信息

#### 4.3.3 工作区信息提示词

**内容**：
```
[工作区信息]
工作区路径：[工作区根目录路径]
```

**工作逻辑**：
- 从文件监听器获取工作区路径
- 如果无法获取，使用当前目录
- 作为系统消息的一部分

**保存位置**：
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream`
- 从 `FileWatcherService` 获取工作区路径

### 4.4 第三层：引用提示词

#### 4.4.1 引用内容提示词

**内容**：
```
[用户引用内容]

以下内容由用户主动引用，已完整传递，请直接使用：

1. 文本引用（来源：[文件路径] 第 [行号范围] 行）
[引用的文本内容]

2. 文件引用（来源：[文件路径]）
[文件的完整内容]

3. 文件夹引用（来源：[文件夹路径]）
[文件夹中所有文件的列表和内容]

4. 图片引用（来源：[图片路径]）
[图片描述或说明]

5. 记忆库引用（来源：记忆库 - [记忆库名称]）
[记忆项内容]

6. 聊天记录引用（来源：[标签页名称]，消息 1-3，[时间戳]）
[聊天记录内容，包含标签页标题、消息角色、消息内容、时间戳]

7. 链接引用（来源：[URL]）
[链接描述]

注意：这些内容无需通过 read_file 工具再次读取。
```

**工作逻辑**：
- 收集用户引用的所有内容
- 按引用类型分类组织，使用精简格式（序号 + 类型 + 来源）
- 格式化引用内容（包含来源、内容）
- 作为用户消息的一部分添加到消息列表
- 统一在末尾说明"无需通过 read_file 工具再次读取"，避免重复说明

**保存位置**：
- 前端：`src/components/Chat/InlineChatInput.tsx` - 收集引用
- 前端：`src/stores/referenceStore.ts` - 管理引用列表
- 前端：`src/utils/referenceHelpers.ts` - 格式化引用内容
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream` - 接收引用信息

#### 4.4.2 引用格式化规则

**文本引用格式化**：
```
[文本引用]
来源：[文件路径]（行号：[行号范围]）
内容：
[引用的文本内容]
```

**文件引用格式化**：
```
[文件引用]
来源：[文件路径]
文件大小：[文件大小]
内容：
[文件的完整内容]
```

**文件夹引用格式化**：
```
[文件夹引用]
来源：[文件夹路径]
包含文件：
- [文件1路径]
- [文件2路径]
...

文件内容：
[所有文件的完整内容]
```

**图片引用格式化**：
```
[图片引用]
来源：[图片路径]
图片类型：[PNG/JPEG/GIF/WebP]
说明：[图片描述或说明]
```

**记忆库引用格式化**：
```
[记忆库引用]
来源：记忆库 - [记忆库名称]
记忆项标题：[标题]
内容：
[记忆项内容]
```

**聊天记录引用格式化**：
```
[聊天记录引用]
来源：[标签页名称]（消息 1-3）
时间：[2025-01-15 14:30] (5 分钟前)
内容：
[标签页标题] [时间戳]
用户: [用户消息内容]
AI: [AI 消息内容]
...
```

**链接引用格式化**：
```
[链接引用]
来源：[URL]
标题：[链接标题]（如有）
说明：[链接描述]
```

### 4.5 第四层：工具调用提示词（仅 Agent 模式）

#### 4.5.1 工具调用规范提示词

**内容**：
```
[工具调用规范]

当你需要执行操作时，可以使用以下工具：

[工具列表]
每个工具包含：
- 工具名称
- 工具描述
- 参数说明
- 返回值说明

工具调用格式：
```json
{
  "tool": "工具名称",
  "arguments": {
    "参数名": "参数值"
  }
}
```

注意：JSON 格式规范已在系统提示词中说明，此处不再重复。
```

**工作逻辑**：
- 仅在 Agent 模式下包含
- 从工具定义服务获取工具列表
- 格式化工具说明
- 作为系统消息的一部分或工具定义传递给 AI

**保存位置**：
- 后端：`src-tauri/src/services/tool_definitions.rs` - 工具定义
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream` - 工具定义传递

#### 4.5.2 工作规划工具提示词

**内容**：
```
[工作规划工具]

工具名称：plan_workflow
工具描述：生成工作规划，包含需要读取的文档、需要浏览的网站、执行步骤等

参数：
- documents: Array<{path: string, name: string, reason: string, relevanceScore: number}>
  需要读取的文档列表
- websites: Array<{url: string, purpose: string, requiresAuth: boolean}>
  需要浏览的网站列表（如有）
- steps: Array<{id: string, description: string, goal: string, dependencies: string[], tools: string[]}>
  执行步骤列表

返回值：
工作规划对象

使用说明：
1. 仅在复杂任务（需要读取3个以上文件或浏览网站）时调用此工具
2. 分析任务需求，识别需要的文档和网站
3. 规划执行步骤，明确步骤之间的依赖关系
4. 规划生成后会展示给用户确认，确认后按步骤执行工具调用
```

**工作逻辑**：
- 作为工具定义的一部分
- AI 可以调用此工具生成工作规划
- 工作规划结果会展示给用户确认

**保存位置**：
- 后端：`src-tauri/src/services/tool_definitions.rs` - 工具定义
- 需要新增 `plan_workflow` 工具定义

---

## 五、提示词构建工作逻辑

### 5.1 层次一提示词构建

**构建流程**：
```
1. 前端触发自动补全
   ↓
2. 提取上下文（光标前 300 字符，优先在段落边界截断）
   ↓
3. 获取文档格式信息
   ↓
4. 构建提示词：
   - 系统提示词（固定）
   - 文档格式信息（动态）
   - 上下文内容（动态）
   - 续写要求（固定）
   ↓
5. 调用后端 ai_autocomplete
   ↓
6. 后端构建消息列表并调用 AI
```

**构建位置**：
- 前端：`src/hooks/useAutoComplete.ts` - 提取上下文和格式信息
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_autocomplete` - 构建提示词

### 5.2 层次二提示词构建

**构建流程**：
```
1. 用户按下 Cmd+K 并输入指令
   ↓
2. 提取上下文（选中文本前后各 500 字符）
   ↓
3. 获取文档格式信息
   ↓
4. 构建提示词：
   - 系统提示词（固定）
   - 文档格式信息（动态）
   - 上下文内容（动态）
   - 用户指令（动态）
   - 选中文本（动态，如有）
   - 任务要求（固定）
   ↓
5. 调用后端 ai_inline_assist
   ↓
6. 后端构建消息列表并调用 AI
```

**构建位置**：
- 前端：`src/hooks/useInlineAssist.ts` - 提取上下文、格式信息、用户指令
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_inline_assist` - 构建提示词

### 5.3 层次三提示词构建

**构建流程**：
```
1. 用户发送消息
   ↓
2. 收集上下文信息：
   - 当前文档信息（如有）
   - 编辑器状态信息
   - 工作区信息
   - 用户引用内容
   ↓
3. 构建多层提示词：
   - 第一层：基础系统提示词（根据模式选择）
   - 第二层：上下文提示词（动态构建）
   - 第三层：引用提示词（如有引用）
   - 第四层：工具调用提示词（Agent 模式）
   ↓
4. 构建消息列表：
   - 系统消息（包含所有提示词层）
   - 历史消息（对话历史）
   - 用户消息（当前消息 + 引用内容）
   ↓
5. 调用后端 ai_chat_stream
   ↓
6. 后端处理消息列表并调用 AI
```

**构建位置**：
- 前端：`src/components/Chat/ChatPanel.tsx` - 收集上下文和引用
- 前端：`src/components/Chat/InlineChatInput.tsx` - 收集用户输入和引用
- 后端：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream` - 构建提示词和消息列表

---

## 六、预设提示词保存位置

### 6.1 当前实现（硬编码）

**层次一系统提示词**：
- 位置：`src-tauri/src/commands/ai_commands.rs::ai_autocomplete`
- 状态：硬编码在函数中

**层次二系统提示词**：
- 位置：`src-tauri/src/commands/ai_commands.rs::ai_inline_assist`
- 状态：硬编码在函数中

**层次三系统提示词（Chat 模式）**：
- 位置：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream`
- 状态：硬编码在函数中（如果消息列表中没有系统消息，会添加默认提示词）

**层次三系统提示词（Agent 模式）**：
- 位置：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream`
- 状态：硬编码在函数中（第 221-223 行和第 227-230 行）

**工具调用 JSON 格式规范**：
- 位置：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream`（系统提示词追加 JSON 规范）
- 状态：硬编码；当消息列表缺少系统消息时自动插入

**工作规划要求（Agent 模式）**：
- 位置：`src-tauri/src/commands/ai_commands.rs::ai_chat_stream`（系统提示词中）
- 状态：硬编码；建议提取为配置文件

**引用格式化规则**：
- 位置：`src/utils/referenceHelpers.ts`、`src/stores/referenceStore.ts`
- 状态：代码内构建；未单独配置

### 6.2 建议的配置化保存位置

为便于迭代和多语言/多模型适配，建议将预设提示词提取为配置文件：
- `src-tauri/src/config/prompts/autocomplete_system_prompt.txt`
- `src-tauri/src/config/prompts/inline_system_prompt.txt`
- `src-tauri/src/config/prompts/chat_system_prompt.txt`
- `src-tauri/src/config/prompts/agent_system_prompt.txt`
- `src-tauri/src/config/prompts/tool_json_rules.txt`（工具调用 JSON 规范）
- `src-tauri/src/config/prompts/plan_workflow_prompt.txt`（工作规划要求）
- `src-tauri/src/config/prompts/reference_format_rules.txt`（引用格式化说明）

加载方式：
- 后端启动时读取上述文件，构建系统提示词和规范文本；
- 前端可选在开发模式下热加载以便快速调试。

---

## 七、提示词示例与模板

### 7.1 自动补全（层次一）
- 系统提示：固定角色 + 续写任务
- 格式提示：动态生成（TXT/t-docx/MD/HTML）
- 上下文：光标前 300 字符（优先在段落边界截断，动态调整 300-500 字符）
- 续写要求：50-100 字，以完整句子结尾，保持风格一致

### 7.2 Inline Assist（层次二）
- 系统提示：固定角色（文档编辑助手）
- 格式提示：动态生成（TXT/t-docx/MD/HTML）
- 上下文：选区前后各 500 字符或光标前后 500 字符
- 用户指令：原样透传
- 任务要求：保持风格与格式，必要时转换格式

### 7.3 聊天窗口（层次三）
- Chat 模式系统提示：角色与能力范围（无工具）
- Agent 模式系统提示：角色 + 工作模式说明（何时规划/直接执行）+ 工具 JSON 规范（统一在末尾）
- 上下文：当前文档/编辑器状态/工作区信息 + 精简格式样式要求
- 文档内容预览：智能选择规则（根据用户消息类型选择内容）
- 引用提示：精简格式传递引用内容，统一说明无需再读
- 工具提示：工具清单、参数、返回值、`plan_workflow` 说明（JSON 规范不再重复）

---

## 八、版本管理与更新策略

- 版本号规则：与功能里程碑对齐（v1.0 基础，v1.1 增加规划，v2.0 配置化）
- 更新流程：
  1) 提示词改动先落地配置文件
  2) 在代码中引用配置文件路径，支持热加载（开发模式）
  3) 变更需更新本《提示词完整文档》与《完整开发方案》
- 回滚策略：保留上一版提示词文件，配置项支持切换/回退

---

## 九、使用注意事项

### 9.1 提示词优化要点

**层次一（自动补全）**：
- 上下文长度：300 字符（动态调整 300-500），优先在段落边界截断
- 续写长度：50-100 字，以完整句子结尾
- 格式约束：明确表述为"普通段落文本，不使用 Markdown 标记、列表符号或代码块"

**层次二（Inline Assist）**：
- 明确选中文本与指令的关系：使用"对选中文本「[文本]」执行操作：[指令]"的结构
- 处理模糊指令：提示 AI 基于上下文推断合理意图

**层次三（聊天窗口）**：
- 格式匹配要求：精简为"匹配当前 [格式] 的样式规范"，详细规则放入文档
- 文档内容预览：根据用户消息类型智能选择（提到某部分 → 包含该部分；整体问题 → 开头+大纲；具体细节 → 光标附近）
- Agent 模式工作规划：明确何时需要规划（3个以上文件/浏览网站），何时直接执行
- JSON 规范：统一在系统提示词末尾，避免重复
- 引用提示：精简格式，统一说明"无需通过 read_file 工具再次读取"

### 9.2 边界条件处理

- **文件读取失败**：提示 AI 说明失败原因，建议替代方案
- **工作区路径为空**：使用当前目录，并在提示词中说明
- **引用内容过大**：超过 10MB 的文件仅传递摘要，提示 AI 需要时可调用 read_file
- **用户指令与文档格式冲突**：优先执行用户指令，但提示可能影响格式一致性

### 9.3 提示词冗余控制

- JSON 格式规范：仅在 Agent 模式系统提示词末尾出现一次
- 格式匹配要求：精简表述，详细规则放入设计文档
- 引用"无需再读"说明：统一在引用内容末尾说明一次，不再对每种类型重复

---

**文档版本**：v1.0  
**创建日期**：2025年  
**最后更新**：2025年  
**维护者**：Binder 开发团队