# 记忆库功能需求文档

## 一、功能概述

记忆库是一个智能知识管理系统，能够自动从文档中提取关键信息（人物、事件、地点、概念、关系等），并以文件树的形式组织展示，帮助用户管理和复用项目中的知识资产。

## 二、核心功能

### 2.1 AI 自动提取记忆

#### 2.1.1 自动提取触发时机
- **文档打开时**：用户打开文档后，系统调用 AI 自动分析文档内容（后端无感处理）
- **文档编辑后**：用户编辑文档并保存，AI 自动分析新增或修改的内容
- **批量处理**：用户可以选择多个文档，批量提取记忆
- **无感体验**：所有提取过程在后台完成，无需用户确认，直接生成记忆库

#### 2.1.2 提取的实体类型
- **人物**：文档中出现的姓名、角色、身份等
- **事件**：重要事件、会议、活动、时间节点等
- **地点**：地理位置、场所、地址等
- **概念**：专业术语、核心概念、理论等
- **关系**：人物之间的关系、事件之间的关联等

#### 2.1.3 提取内容
每个记忆包含以下信息：
- **实体名称**：实体的主要标识
- **实体描述**：AI 提取的实体详细描述
- **来源文档**：该记忆来自哪个文档
- **出现位置**：在文档中的具体位置（可选）
- **置信度**：AI 提取的置信度评分
- **关联信息**：与其他实体的关系、属性等

#### 2.1.4 提取方式
- **全自动无感提取**：文档打开后自动提取，后端处理，无需用户操作，直接生成记忆库
- **成本优化策略**：根据文档大小采用不同的提取策略，平衡成本与效果

#### 2.1.5 成本控制与提取策略

**文档大小分界线：10 万字**

**小文档（≤10 万字）：**
- **策略**：直接调用 AI 全量提取实体
- **处理方式**：一次性分析完整文档内容
- **成本**：可控（单次约 $0.1-0.5）
- **时间**：几秒到 1 分钟
- **结果**：直接生成完整记忆库

**大文档（>10 万字）：**
- **策略**：两阶段提取机制
  - **第一阶段**：本地提取文档大纲和结构索引（零成本）
  - **第二阶段**：按需深入提取（实际使用时触发，AI 提取）

**第一阶段 - 本地大纲提取逻辑：**
1. **文档结构分析**（本地处理）：
   - 本地解析文档格式（Word、PDF、Markdown 等）
   - 本地提取章节标题、段落结构
   - 本地识别文档层级（一级标题、二级标题等）
   - 本地建立文档索引（章节位置、页码等）

2. **关键信息提取**（本地处理）：
   - 本地提取章节首段或摘要段落（作为章节摘要）
   - 本地识别关键实体名称（通过关键词匹配、命名实体识别等，不含详细描述）
   - 本地建立实体索引（实体名称 → 所在章节位置）

3. **生成大纲记忆**：
   - 记忆项包含：实体名称、所在章节、章节摘要（本地提取）
   - 不包含：详细描述、完整内容（需 AI 深入分析）
   - 标记为"大纲记忆"状态

**第二阶段 - 按需深入提取：**
- **触发时机**：当用户实际使用记忆时（AI 对话、搜索、查看详情）
- **提取方式**：
  1. 根据大纲索引定位到具体章节位置
  2. 提取该章节的完整内容
  3. 调用 AI 深入分析该章节，提取详细描述
  4. 更新记忆项，补充完整信息
- **成本控制**：只提取实际使用的部分，避免全量分析的高成本

**示例流程：**
```
用户打开 100 万字小说
  ↓
本地提取大纲（零成本，快速完成）
  ↓
生成大纲记忆：张三（第一章）、李四（第二章）...
  ↓
用户与 AI 对话："张三的性格特点是什么？"
  ↓
系统根据大纲索引定位到第一章
  ↓
提取第一章内容，AI 深入分析（成本约 $0.1）
  ↓
更新"张三"记忆，补充详细描述
  ↓
AI 使用完整记忆回答用户问题
```

**格式处理：**
- **PPT/PDF/图片**：先转换为文本，再按上述策略处理（大文档本地提取大纲，小文档 AI 提取）
- **表格/图表**：本地提取结构化数据，系统建立索引
- **多格式文档**：统一转换为文本格式后处理

**成本优势：**
- **小文档**：AI 直接提取，成本低，体验好
- **大文档**：本地提取大纲零成本，按需深入成本可控（每次约 $0.1-1）
- **一亿字文档**：本地提取大纲零成本，按需深入每次约 $0.1-1
- **总体成本**：相比全量提取降低 95% 以上（大文档大纲提取零成本）

### 2.2 文件树展示

#### 2.2.1 树形结构
记忆库采用类似文件树的层级结构展示：

```
记忆库
├─ 📄 小说/第一章.docx
│  ├─ 👤 人物
│  │  ├─ 张三（主角，25岁，程序员）
│  │  └─ 李四（配角，30岁，设计师）
│  ├─ 📅 事件
│  │  ├─ 项目启动会（2024年1月）
│  │  └─ 产品发布会（2024年3月）
│  ├─ 📍 地点
│  │  └─ 北京办公室（朝阳区）
│  └─ 💡 概念
│     └─ 敏捷开发方法论
├─ 📄 发布会/演讲稿.docx
│  ├─ 👤 人物
│  │  └─ 王五（CEO）
│  └─ 📅 事件
│     └─ 产品发布会（2024年3月）
└─ 📄 vlog/2024-01.md
   └─ 📅 事件
      └─ 旅行日记（2024年1月）
```

#### 2.2.2 展示规则
- **第一层**：按文档路径分组，显示文档名称和图标
- **第二层**：按实体类型分组（人物、事件、地点、概念、关系）
- **第三层**：具体的记忆项，显示实体名称和简要描述
- **展开/折叠**：支持点击展开或折叠任意层级
- **数量标识**：每个节点显示包含的记忆数量，如"人物（3）"

#### 2.2.3 视觉设计
- **文档节点**：使用文档图标，显示文档名称
- **类型节点**：使用类型图标（人物👤、事件📅、地点📍、概念💡、关系🔗）
- **记忆节点**：显示实体名称，悬停显示完整描述
- **选中状态**：点击记忆项后高亮显示
- **空状态**：文档或类型下无记忆时，显示"暂无记忆"

### 2.3 记忆管理

#### 2.3.1 查看记忆详情
- **点击记忆项**：在侧边栏或弹窗中显示完整记忆信息
- **显示内容**：
  - 实体名称和类型
  - 完整描述
  - 来源文档（可点击跳转）
  - 置信度
  - 关联的其他记忆
  - 属性信息
  - 标签

#### 2.3.2 编辑记忆
- **修改内容**：用户可以修改 AI 提取的描述、属性等信息
- **添加信息**：用户可以补充 AI 未提取的信息
- **删除记忆**：用户可以删除不需要的记忆
- **合并记忆**：如果发现重复记忆，可以合并

#### 2.3.3 记忆状态
- **大纲记忆**：大文档提取的大纲记忆，包含基本信息，标记为"大纲"状态
- **完整记忆**：小文档直接提取或大文档按需深入后的完整记忆，包含详细描述
- **自动生成**：所有记忆自动生成，无需用户确认，直接可用
- **自动升级**：大纲记忆在使用时自动升级为完整记忆

### 2.4 搜索与筛选

#### 2.4.1 全局搜索
- **搜索位置**：在资源管理区顶部搜索框
- **搜索范围**：搜索所有记忆的实体名称、描述、标签
- **实时搜索**：输入关键词后实时过滤显示结果
- **高亮显示**：搜索结果中高亮显示匹配的关键词

#### 2.4.2 筛选功能
- **按文档筛选**：只显示特定文档的记忆
- **按类型筛选**：只显示特定类型的记忆（如只看人物）
- **按状态筛选**：只显示已确认或建议状态的记忆
- **组合筛选**：支持多个筛选条件组合使用

#### 2.4.3 搜索集成
- **记忆库展开时**：顶部搜索框自动切换为"搜索记忆..."
- **搜索结果**：在记忆库树中高亮显示匹配的记忆项
- **自动展开**：搜索结果自动展开包含匹配项的节点

### 2.5 AI 智能使用

#### 2.5.1 自动选择相关记忆
当用户与 AI 对话或编辑文档时：
- **上下文分析**：AI 分析当前文档内容、对话历史
- **自动检索**：从记忆库中检索相关记忆（包括大纲记忆和完整记忆）
- **智能选择**：根据相关性评分选择最相关的记忆
- **按需深入**：如果选中的是大纲记忆，自动触发深入提取，升级为完整记忆
- **自动注入**：将选中的记忆（完整记忆）自动加入 AI 的上下文

#### 2.5.2 记忆使用提示
- **显示使用**：在聊天界面显示"使用了以下记忆"
- **可查看**：用户可以查看 AI 使用了哪些记忆
- **可调整**：用户可以手动添加或移除记忆
- **使用历史**：记录记忆的使用频率和最近使用时间

#### 2.5.3 记忆推荐
- **相关推荐**：基于当前上下文推荐可能相关的记忆
- **相似记忆**：推荐与当前记忆相似的其他记忆
- **关联记忆**：推荐与当前记忆有关联关系的记忆

### 2.6 项目区分

#### 2.6.1 按文档路径区分
- **自动分组**：根据文档的文件夹路径自动分组
- **项目识别**：同一文件夹下的文档记忆归为一组
- **跨项目**：不同文件夹的记忆自动区分

#### 2.6.2 项目视图（可选）
- **项目模式**：用户可以选择按项目查看记忆
- **项目树**：第一层显示项目，第二层显示文档
- **项目切换**：可以切换查看不同项目的记忆

## 三、用户交互流程

### 3.1 首次使用
1. 用户打开文档
2. AI 后端无感分析文档内容
3. 根据文档大小选择提取策略：
   - 小文档（≤10 万字）：AI 直接提取完整记忆
   - 大文档（>10 万字）：本地提取大纲记忆
4. 记忆自动生成并添加到记忆库（无需用户确认）
5. 记忆库树形结构自动更新

### 3.2 日常使用
1. 用户打开记忆库面板
2. 查看按文档组织的记忆树
3. 点击记忆项查看详情
4. 在顶部搜索框搜索记忆
5. AI 对话时自动使用相关记忆

### 3.3 编辑记忆
1. 用户点击记忆项
2. 在详情面板中查看完整信息
3. 点击"编辑"按钮
4. 修改记忆内容
5. 保存后更新记忆库

## 四、功能特性

### 4.1 智能特性
- **自动提取**：无需手动输入，AI 自动识别和提取
- **智能分类**：AI 自动识别实体类型并正确分类
- **关联发现**：AI 自动发现实体之间的关系
- **去重处理**：AI 自动识别重复记忆并提示合并

### 4.2 用户体验
- **树形展示**：直观的文件树结构，易于浏览
- **快速搜索**：集成到顶部搜索，快速查找
- **批量操作**：支持批量确认、删除等操作
- **可视化**：清晰的图标和层级结构

### 4.3 数据管理
- **持久化存储**：所有记忆自动保存到本地数据库
- **同步更新**：文档修改后，AI 自动更新相关记忆
- **版本管理**：记录记忆的创建和修改时间
- **导出功能**：支持导出记忆数据（可选）

## 五、边界与限制

### 5.1 提取限制
- **文档大小**：
  - 小文档（≤10 万字）：AI 直接全量提取
  - 大文档（>10 万字）：本地提取大纲 + AI 按需深入
  - 理论上限：无限制（通过本地大纲 + AI 按需机制处理）
- **提取精度**：AI 提取可能存在误差，但无需用户确认，直接生成
- **语言支持**：主要支持中文，其他语言可能精度较低
- **格式支持**：支持文本、Word、PDF、PPT 等（需先转换为文本）

### 5.2 性能考虑
- **提取速度**：
  - 小文档：AI 提取几秒到 1 分钟
  - 大文档本地大纲提取：几秒到 1 分钟（本地处理，速度快）
  - 按需深入：AI 提取几秒到 1 分钟
- **显示数量**：单个文档的记忆数量建议不超过 100 个
- **搜索性能**：记忆库过大时，搜索可能需要优化
- **成本控制**：通过本地大纲 + AI 按需机制，大文档成本降低 95% 以上（大纲提取零成本）

### 5.3 用户控制
- **无感体验**：所有提取在后台完成，用户无需等待或确认
- **删除权限**：用户可以随时删除不需要的记忆
- **编辑权限**：用户可以修改 AI 提取的内容
- **成本透明**：用户可查看提取成本统计（可选）

## 六、未来扩展（可选）

### 6.1 高级功能
- **记忆模板**：为不同类型项目创建记忆模板
- **记忆标签**：支持自定义标签分类
- **记忆统计**：显示记忆库的统计信息
- **记忆导出**：导出为 Markdown、JSON 等格式

### 6.2 协作功能
- **共享记忆**：团队成员共享记忆库
- **记忆评论**：对记忆添加评论和备注
- **记忆版本**：记录记忆的修改历史

### 6.3 智能增强
- **学习优化**：根据用户确认情况优化 AI 提取算法
- **语义搜索**：支持语义相似度搜索
- **自动关联**：自动发现和建立记忆之间的关联

## 七、成功标准

### 7.1 功能完整性
- ✅ AI 能够自动提取文档中的关键实体
- ✅ 记忆库以文件树形式清晰展示
- ✅ 用户能够方便地查看、编辑、删除记忆
- ✅ 搜索功能能够快速定位记忆

### 7.2 用户体验
- ✅ 提取过程对用户透明，无需额外操作
- ✅ 树形结构直观易懂，符合用户习惯
- ✅ 搜索集成自然，不打断工作流程
- ✅ AI 使用记忆时用户可见可控

### 7.3 实用性
- ✅ 能够有效区分不同项目的记忆
- ✅ 提取的记忆准确有用
- ✅ 能够帮助用户更好地管理和复用知识
- ✅ 提升 AI 对话和文档编辑的质量

