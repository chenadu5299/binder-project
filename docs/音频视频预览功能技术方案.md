# 音频视频预览功能技术方案

## 文档信息

- **文档版本**：v1.0
- **创建日期**：2025年1月
- **文档性质**：技术架构文档
- **适用范围**：Binder 音频和视频文件预览功能
- **技术栈**：Tauri + React + TypeScript + HTML5 Media API

---

## 格式支持情况总览

### 音频格式支持

| 格式 | 扩展名 | 支持情况 | 说明 |
|------|--------|----------|------|
| MP3 | .mp3 | ✅ 完全支持 | 所有浏览器原生支持 |
| WAV | .wav | ✅ 完全支持 | 所有浏览器原生支持 |
| OGG | .ogg | ✅ 完全支持 | Chrome/Firefox 原生支持（Tauri 使用 Chromium） |
| AAC | .aac | ✅ 完全支持 | 广泛支持 |
| M4A | .m4a | ✅ 完全支持 | 基于 AAC，广泛支持 |
| FLAC | .flac | ⚠️ 部分支持 | Chrome/Firefox 支持，可能不稳定 |
| Opus | .opus | ⚠️ 部分支持 | 现代浏览器支持，兼容性不如 MP3 |
| WMA | .wma | ❌ 不支持 | 需要格式转换（转换为 MP3/WAV） |

### 视频格式支持

| 格式 | 扩展名 | 支持情况 | 说明 |
|------|--------|----------|------|
| MP4 | .mp4 | ✅ 完全支持 | H.264 编码，所有浏览器原生支持 |
| WebM | .webm | ✅ 完全支持 | Chrome/Firefox/Edge 原生支持 |
| OGG | .ogg | ✅ 完全支持 | Chrome/Firefox 原生支持 |
| MOV | .mov | ⚠️ 部分支持 | 主要 Safari 支持，Chromium 支持有限 |
| AVI | .avi | ❌ 不支持 | 需要格式转换（转换为 MP4/WebM） |
| MKV | .mkv | ❌ 不支持 | 需要格式转换（转换为 MP4/WebM） |
| FLV | .flv | ❌ 不支持 | 需要格式转换（转换为 MP4/WebM） |
| WMV | .wmv | ❌ 不支持 | 需要格式转换（转换为 MP4/WebM） |

**说明：**
- ✅ **完全支持**：可直接预览，无需转换
- ⚠️ **部分支持**：可尝试预览，失败时提示用户转换
- ❌ **不支持**：需要格式转换（可选功能，需要后端 FFmpeg 支持）

---

## 一、技术选型原则

### 1.1 选型原则

**核心原则：**
1. **稳定性优先**：使用浏览器原生 HTML5 Media API，无需第三方库
2. **兼容性优先**：支持主流音频和视频格式
3. **一致性优先**：与现有预览功能（PDF、图片）保持技术方案一致
4. **性能优先**：合理处理大文件，避免内存溢出
5. **可维护性优先**：代码简洁，易于扩展

**技术选型标准：**
- ✅ 成熟稳定：HTML5 Media API 是 W3C 标准，浏览器原生支持
- ✅ 无需依赖：不引入额外的媒体播放库
- ✅ 统一方案：复用现有 base64 文件读取机制
- ✅ 性能可控：通过文件大小限制和 Blob URL 优化内存

---

## 二、核心需求分析

### 2.1 功能需求

**音频格式支持情况（基于 Chromium/Tauri WebView）：**

✅ **完全支持（可直接预览）：**
- **MP3（.mp3）** - 广泛支持，所有浏览器原生支持
- **WAV（.wav）** - 广泛支持，所有浏览器原生支持
- **OGG（.ogg）** - Chrome/Firefox 原生支持（Tauri 使用 Chromium，支持良好）
- **AAC（.aac）** - 广泛支持（通常嵌入在 MP4 容器中）
- **M4A（.m4a）** - 广泛支持（基于 AAC 编码，Chromium 支持）

⚠️ **部分支持（可能不稳定，建议测试）：**
- **FLAC（.flac）** - Chrome/Firefox 支持，但可能不稳定，建议提供降级提示
- **Opus（.opus）** - 现代浏览器支持，但兼容性不如 MP3/WAV

❌ **不支持（需要格式转换）：**
- **WMA（.wma）** - 浏览器不支持，需要后端转换为 MP3/WAV

**视频格式支持情况（基于 Chromium/Tauri WebView）：**

✅ **完全支持（可直接预览）：**
- **MP4（.mp4）** - 广泛支持（H.264 编码），所有浏览器原生支持
- **WebM（.webm）** - Chrome/Firefox/Edge 原生支持（Tauri 使用 Chromium，支持良好）
- **OGG（.ogg）** - Chrome/Firefox 原生支持

⚠️ **部分支持（可能不稳定，建议测试）：**
- **MOV（.mov）** - 主要 Safari 支持，Chromium 支持有限（取决于编码格式），建议提供降级提示

❌ **不支持（需要格式转换）：**
- **AVI（.avi）** - 浏览器不支持，需要转换为 MP4/WebM
- **MKV（.mkv）** - 浏览器不支持，需要转换为 MP4/WebM
- **FLV（.flv）** - 浏览器不支持，需要转换为 MP4/WebM
- **WMV（.wmv）** - 浏览器不支持，需要转换为 MP4/WebM

**格式转换方案（可选，后续扩展）：**
- 对于不支持的格式，可以集成 FFmpeg 进行格式转换
- 转换策略：检测到不支持格式时，提示用户是否转换，或自动转换为兼容格式
- 转换目标：音频 → MP3/WAV，视频 → MP4/WebM

**核心功能：**
- 音频/视频文件预览播放
- 基础播放控制（播放/暂停、进度条、音量控制）
- 文件信息显示（文件名、时长、文件大小）
- 错误处理和格式兼容性提示

### 2.2 性能需求

**加载性能：**
- 小文件（< 10MB）：即时加载
- 中等文件（10-50MB）：< 5 秒
- 大文件（> 50MB）：提示用户或限制大小

**资源占用：**
- 内存占用：合理控制，避免大文件导致内存溢出
- CPU 占用：播放时 < 20%

### 2.3 兼容性需求

**浏览器兼容性：**
- 基于 Tauri WebView（Chromium 内核），兼容性良好
- 支持主流音频和视频格式
- 不支持的格式提供友好提示

---

## 三、技术架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (React)                         │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          MediaPreview Component                      │   │
│  │  (统一处理音频和视频预览)                              │   │
│  │                                                       │   │
│  │  ┌──────────────┐  ┌──────────────┐                  │   │
│  │  │ Audio Player │  │ Video Player │                  │   │
│  │  │  (HTML5)     │  │  (HTML5)     │                  │   │
│  │  └──────────────┘  └──────────────┘                  │   │
│  └───────────────────┬──────────────────────────────────┘   │
│                      │                                        │
│              ┌───────▼────────┐                               │
│              │  Media Service │                               │
│              │ (文件加载服务)  │                               │
│              └───────┬────────┘                               │
└──────────────────────┼────────────────────────────────────────┘
                       │
┌──────────────────────▼────────────────────────────────────────┐
│                    Tauri 命令层 (Rust)                         │
│  ┌──────────────────────────────────────────────────────┐     │
│  │      read_file_as_base64 (复用现有命令)              │     │
│  └──────────────────────────────────────────────────────┘     │
└────────────────────────────────────────────────────────────────┘
```

### 3.2 组件架构

**MediaPreview 组件结构：**
```
MediaPreview
├── 文件类型检测
│   ├── 音频格式识别
│   └── 视频格式识别
├── 文件加载
│   ├── 调用 read_file_as_base64
│   ├── Base64 转 Blob
│   └── 创建 Blob URL
├── 播放器渲染
│   ├── <audio> 标签（音频）
│   └── <video> 标签（视频）
├── 播放控制
│   ├── 播放/暂停
│   ├── 进度条
│   ├── 音量控制
│   └── 全屏（视频）
└── 错误处理
    ├── 格式不支持提示
    ├── 文件损坏提示
    └── 加载失败提示
```

---

## 四、技术实现方案

### 4.1 文件类型识别

**扩展文件类型定义：**

在 `src/types/file.ts` 中扩展 `FileType`：
- 添加 `'audio'` 类型
- 添加 `'video'` 类型

**文件扩展名映射：**

音频格式识别：
- `.mp3` → `audio/mpeg` ✅
- `.wav` → `audio/wav` ✅
- `.ogg` → `audio/ogg` ✅
- `.aac` → `audio/aac` ✅
- `.m4a` → `audio/mp4` ✅
- `.flac` → `audio/flac` ⚠️
- `.opus` → `audio/opus` ⚠️
- `.wma` → `audio/x-ms-wma` ❌（不支持，需要转换）

视频格式识别：
- `.mp4` → `video/mp4` ✅
- `.webm` → `video/webm` ✅
- `.ogg` → `video/ogg` ✅
- `.mov` → `video/quicktime` ⚠️
- `.avi` → `video/x-msvideo` ❌（不支持，需要转换）
- `.mkv` → `video/x-matroska` ❌（不支持，需要转换）
- `.flv` → `video/x-flv` ❌（不支持，需要转换）
- `.wmv` → `video/x-ms-wmv` ❌（不支持，需要转换）

### 4.2 文件加载策略

**方案选择：Blob URL（推荐）**

**技术要点：**
1. 使用现有的 `read_file_as_base64` Tauri 命令读取文件
2. 将 Base64 字符串转换为 `Uint8Array`
3. 创建 `Blob` 对象并指定正确的 MIME 类型
4. 使用 `URL.createObjectURL()` 创建 Blob URL
5. 将 Blob URL 传递给 `<audio>` 或 `<video>` 标签的 `src` 属性

**优势：**
- 内存效率高：Blob URL 不占用大量内存
- 性能好：浏览器可以流式加载
- 资源管理：组件卸载时自动释放（URL.revokeObjectURL）

**实现示例流程：**
```
1. 调用 read_file_as_base64(filePath)
2. 获取 Base64 字符串
3. 解码 Base64 → Uint8Array
4. 创建 Blob([Uint8Array], { type: mimeType })
5. 创建 Blob URL → URL.createObjectURL(blob)
6. 设置 <audio src={blobUrl}> 或 <video src={blobUrl}>
7. 组件卸载时 → URL.revokeObjectURL(blobUrl)
```

### 4.3 播放器实现

**音频播放器：**

使用 HTML5 `<audio>` 标签，包含：
- 播放/暂停按钮
- 进度条（可拖拽）
- 当前时间/总时长显示
- 音量控制
- 播放速度控制（可选）

**视频播放器：**

使用 HTML5 `<video>` 标签，包含：
- 播放/暂停按钮
- 进度条（可拖拽）
- 当前时间/总时长显示
- 音量控制
- 全屏按钮
- 播放速度控制（可选）

**播放控制实现：**

通过 React state 管理播放状态：
- `isPlaying`: 播放/暂停状态
- `currentTime`: 当前播放时间
- `duration`: 总时长
- `volume`: 音量（0-1）
- `playbackRate`: 播放速度（0.5x, 1x, 1.5x, 2x）

使用 `useRef` 获取 `<audio>` 或 `<video>` 元素的引用，通过 DOM API 控制播放。

### 4.4 文件大小处理

**大小限制策略：**

1. **小文件（< 10MB）**：直接加载，无限制
2. **中等文件（10-50MB）**：正常加载，显示加载进度
3. **大文件（> 50MB）**：
   - 方案 A：提示用户文件较大，询问是否继续加载
   - 方案 B：限制最大文件大小（如 100MB），超过则提示

**加载进度显示：**

- 使用 `fetch` API 的 `Response.body` 可以实现流式加载
- 但由于使用 base64，无法直接获取加载进度
- 替代方案：显示"正在加载..."状态，完成后显示播放器

### 4.5 错误处理

**格式不支持检测：**

检测浏览器是否支持特定格式：
- 使用 `HTMLAudioElement.canPlayType()` 或 `HTMLVideoElement.canPlayType()`
- 返回 `'probably'`、`'maybe'` 或 `''`（不支持）
- 在文件加载前检测格式支持情况

**处理策略：**

1. **完全支持的格式（✅）**：直接加载播放
2. **部分支持的格式（⚠️）**：
   - 尝试加载，如果失败则提示："此格式可能不支持，建议转换为 MP3/MP4 格式"
   - 提供格式转换建议
3. **不支持的格式（❌）**：
   - 直接提示："此格式不支持，请转换为以下格式："
   - 音频：MP3、WAV、OGG、AAC、M4A
   - 视频：MP4、WebM
   - 可选：提供格式转换功能（需要后端 FFmpeg 支持）

**文件损坏：**

监听 `<audio>` 或 `<video>` 的 `error` 事件：
- `MEDIA_ERR_ABORTED`: 用户中止加载
- `MEDIA_ERR_NETWORK`: 网络错误
- `MEDIA_ERR_DECODE`: 解码错误（文件可能损坏）
- `MEDIA_ERR_SRC_NOT_SUPPORTED`: 格式不支持

**加载超时：**

设置加载超时（如 30 秒）：
- 超时后提示用户："文件加载超时，请检查文件大小或网络连接"

### 4.6 文件信息显示

**元数据提取：**

- **文件名**：从文件路径提取
- **文件大小**：通过 Tauri 命令获取文件元数据
- **时长**：通过 `<audio>` 或 `<video>` 元素的 `duration` 属性获取（加载完成后）
- **格式信息**：从文件扩展名和 MIME 类型推断

**显示位置：**

- 播放器上方或侧边显示文件信息卡片
- 包含：文件名、文件大小、格式、时长（加载后显示）

---

## 五、集成方案

### 5.1 文件类型识别集成

**在 `src/services/documentService.ts` 中：**

扩展 `getFileType` 函数，添加音频和视频格式识别：
- 识别音频扩展名 → 返回 `'audio'`
- 识别视频扩展名 → 返回 `'video'`

**在 `FILE_OPEN_STRATEGIES` 中添加：**

```typescript
audio: {
  new: { fileType: 'audio', source: 'new', canEdit: false, previewMode: true, requiresConversion: false },
  external: { fileType: 'audio', source: 'external', canEdit: false, previewMode: true, requiresConversion: false },
  ai_generated: { fileType: 'audio', source: 'ai_generated', canEdit: false, previewMode: true, requiresConversion: false },
},
video: {
  // 类似配置
}
```

### 5.2 编辑器面板集成

**在 `src/components/Editor/EditorPanel.tsx` 中：**

扩展 `getFileType` 函数，添加音频和视频识别。

在文件渲染逻辑中添加：
```typescript
if (fileType === 'audio' || fileType === 'video') {
  return <MediaPreview filePath={activeTab.filePath} fileType={fileType} />;
}
```

### 5.3 文件树集成

**在 `src/components/FileTree/FileTree.tsx` 中：**

扩展 `supportedTypes` 数组，添加音频和视频扩展名：

**完全支持的格式（可直接打开）：**
- 音频：`'mp3', 'wav', 'ogg', 'aac', 'm4a'`
- 视频：`'mp4', 'webm', 'ogg'`

**部分支持的格式（可尝试打开，失败时提示）：**
- 音频：`'flac', 'opus'`
- 视频：`'mov'`

**不支持的格式（可选，打开时提示转换）：**
- 音频：`'wma'`
- 视频：`'avi', 'mkv', 'flv', 'wmv'`

**实现建议：**
- 完全支持的格式：直接打开预览
- 部分支持的格式：尝试打开，失败时显示友好提示
- 不支持的格式：显示格式转换提示，或集成转换功能

---

## 六、技术稳定性保障

### 6.1 浏览器兼容性

**Tauri WebView 环境：**
- 基于 Chromium 内核，HTML5 Media API 支持完整
- 无需考虑旧版浏览器兼容性
- 支持的格式范围广

**格式兼容性检测：**

在组件加载时检测浏览器支持的格式：
- 使用 `canPlayType()` API
- 不支持的格式提前提示用户

### 6.2 内存管理

**Blob URL 生命周期管理：**

- 组件挂载时创建 Blob URL
- 组件卸载时调用 `URL.revokeObjectURL()` 释放资源
- 使用 `useEffect` 的清理函数确保资源释放

**大文件处理：**

- 文件大小检查：加载前检查文件大小
- 超过限制时提示用户或拒绝加载
- 避免一次性加载超大文件导致内存溢出

### 6.3 错误恢复

**加载失败处理：**

- 捕获所有可能的错误（网络错误、解码错误、格式错误）
- 显示友好的错误提示
- 提供重试机制（可选）

**播放错误处理：**

- 监听媒体元素的 `error` 事件
- 根据错误类型显示不同的提示信息
- 允许用户重新加载文件

### 6.4 性能优化

**懒加载：**

- 只有在文件被打开时才加载
- 不在文件树中预加载

**缓存策略：**

- Blob URL 在组件生命周期内缓存
- 切换标签页时保持播放状态（可选）
- 关闭标签页时释放资源

---

## 七、实现步骤

### 7.1 第一阶段：基础功能（2-3 天）

**任务清单：**
1. 扩展文件类型定义（`src/types/file.ts`）
2. 扩展文件类型识别（`src/services/documentService.ts`）
3. 创建 `MediaPreview` 组件（`src/components/Editor/MediaPreview.tsx`）
4. 实现基础播放功能（播放/暂停、进度条）
5. 集成到编辑器面板（`EditorPanel.tsx`）
6. 基础错误处理

**验收标准：**
- MP3 和 MP4 文件可以正常播放
- 播放控制功能正常
- 错误提示友好

### 7.2 第二阶段：功能完善（1-2 天）

**任务清单：**
1. 添加音量控制
2. 添加播放速度控制
3. 添加文件信息显示
4. 添加全屏功能（视频）
5. 完善错误处理（格式检测、友好提示）

**验收标准：**
- 所有播放控制功能正常
- 文件信息显示准确
- 错误处理完善

### 7.3 第三阶段：优化和测试（1 天）

**任务清单：**
1. 大文件处理优化
2. 内存管理优化
3. 兼容性测试（不同格式）
4. 性能测试（大文件加载）
5. 用户体验优化

**验收标准：**
- 大文件处理稳定
- 内存占用合理
- 所有支持的格式测试通过

---

## 八、技术要点总结

### 8.1 核心技术

1. **HTML5 Media API**：使用浏览器原生 `<audio>` 和 `<video>` 标签
2. **Blob URL**：高效的文件加载方式，内存友好
3. **Base64 转换**：复用现有的文件读取机制
4. **React Hooks**：使用 `useState`、`useEffect`、`useRef` 管理状态和生命周期

### 8.2 关键实现点

1. **文件加载流程**：Base64 → Uint8Array → Blob → Blob URL → Media Element
2. **资源管理**：组件卸载时释放 Blob URL，避免内存泄漏
3. **格式检测**：使用 `canPlayType()` 检测浏览器支持的格式
4. **错误处理**：监听媒体元素的 `error` 事件，提供友好提示

### 8.3 稳定性保障

1. **浏览器兼容性**：基于 Chromium 内核，兼容性良好
2. **内存管理**：使用 Blob URL 和及时释放资源
3. **错误恢复**：完善的错误处理和用户提示
4. **性能优化**：文件大小限制和懒加载策略

---

## 九、后续扩展方向

### 9.1 功能扩展

- **播放列表**：支持多个文件连续播放
- **字幕支持**：视频文件支持外挂字幕
- **播放历史**：记录播放位置，下次打开时继续播放
- **快捷键**：支持键盘快捷键控制播放

### 9.2 性能优化

- **流式加载**：后端支持流式读取，实现真正的进度显示
- **格式转换**：不支持的格式自动转换为支持的格式（需要后端 FFmpeg 支持）
- **缓存优化**：缓存已加载的文件，提升二次打开速度

### 9.3 格式转换功能（可选扩展）

**转换需求：**
- 对于不支持的格式（WMA、AVI、MKV、FLV、WMV），提供格式转换功能
- 使用 FFmpeg 进行格式转换

**转换策略：**
- **音频转换**：WMA → MP3/WAV
- **视频转换**：AVI/MKV/FLV/WMV → MP4/WebM

**实现方案：**
- 后端集成 FFmpeg（Rust FFmpeg 绑定）
- 检测到不支持格式时，提示用户是否转换
- 转换过程显示进度
- 转换后的文件可临时存储或替换原文件

**技术要点：**
- 使用 `ffmpeg-next` 或 `ffmpeg-sys` Rust crate
- 转换命令示例：`ffmpeg -i input.wma -acodec libmp3lame output.mp3`
- 视频转换：`ffmpeg -i input.avi -c:v libx264 -c:a aac output.mp4`

---

**文档版本**：v1.0  
**创建日期**：2025年1月  
**最后更新**：2025年1月  
**状态**：技术方案文档，待实现

