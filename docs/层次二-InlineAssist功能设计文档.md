# 层次二：Inline Assist（Cmd+K 快捷键）功能设计文档

## 文档信息

- **文档版本**：v1.0
- **创建日期**：2025年
- **文档性质**：功能设计文档
- **功能层次**：层次二

## 格式说明

**重要**：本文档中提到的文档格式说明：
- **原生 DOCX**：Word 原生的 .docx 文件，Binder 只能预览，不能编辑
- **t-docx**：Binder 可编辑的文档格式（TipTap 模拟的 DOCX），包括：
  - Binder 生成的文档
  - 从预览模式切换到编辑模式时创建的草稿文件（如 `document.draft.docx`）
  - 所有在 Binder 编辑器中可编辑的文档

本文档中所有涉及"可编辑"、"格式匹配"、"样式继承"等场景下的 DOCX，均指 **t-docx** 格式。

---

## 一、功能定位

### 1.1 核心特性

- **独立输入框**：不是聊天窗口，是浮动的输入框
- **快捷键调出**：只能通过 Cmd+K（或 Ctrl+K）激活
- **指令驱动**：根据用户指令执行多种操作（修改/生成/分析/匹配）
- **灵活交互**：支持有/无选中文本两种场景
- **直接应用结果**：反馈直接应用到选中的文本区域或光标位置
- **无对话历史**：每次调用都是独立的，不保存历史

### 1.2 使用场景

**文本修改类**：
- 文本润色、改写、翻译
- 格式转换（如"转换为 Markdown"）
- 风格调整（如"改得更正式"）

**内容生成类**：
- 续写、补充、生成摘要
- 生成标题、开头、结尾

**分析讨论类**：
- 分析文本、讨论观点
- 解释概念、说明原理

**匹配查找类**：
- 查找类似表达、匹配相关概念
- 检查一致性、验证准确性

### 1.3 功能边界

- **不共享**：聊天历史、对话上下文
- **共享**：当前文档内容、选中文本、系统提示词、AI 模型配置

---

## 二、触发机制

### 2.1 触发条件

- 用户按下 **Cmd+K**（macOS）或 **Ctrl+K**（Windows/Linux）
- 可选：用户选中文本（也可以不选）
- 在光标位置或选中文本位置显示输入框

### 2.2 触发逻辑

- 监听 Cmd+K 快捷键
- 获取选中的文本（如果有）
- 显示浮动输入框
- 用户输入指令后执行

### 2.3 取消机制

- **Esc 键**：取消操作，关闭输入框
- **点击外部**：点击输入框外部区域关闭
- **执行完成**：执行完成后自动关闭

---

## 三、提示词设计（优化后）

### 3.1 提示词结构

**完整提示词结构**：
```
[系统提示词]
你是一个专业的文档编辑助手，可以根据用户指令执行多种操作：
- 文本修改：改写、润色、翻译、格式转换等
- 内容生成：续写、补充、生成摘要等
- 分析讨论：分析文本、讨论观点、解释概念等
- 匹配查找：查找相关内容、匹配概念、检查一致性等

请根据用户指令的类型，选择合适的方式处理。

[文档格式信息]
当前文档格式：[格式类型]（.txt、.t-docx、.md、.html 等）
当前位置格式：[段落/列表/表格/代码块等]
格式要求：[根据格式类型和指令动态生成]

[上下文内容]
[根据是否有选中文本动态构建]

[用户指令]
[用户输入的指令]

[指令分析]
指令类型：[修改/生成/分析/匹配]（自动识别）
处理方式：[根据指令类型确定]

[任务要求]
根据指令类型执行相应操作：
- 修改：修改文本，保持语义不变，匹配格式和样式
- 生成：生成内容，匹配上下文风格和格式
- 分析：分析文本，输出分析结果，保持客观专业
- 匹配：查找匹配内容，输出匹配结果
```

### 3.2 上下文选择规则（优化后）

#### 3.2.1 有选中文本场景

- **选中文本**：提取用户选中的文本
- **上下文（前）**：选中文本前 500 字符
- **上下文（后）**：选中文本后 500 字符
- **格式识别**：识别选中文本的格式和样式

#### 3.2.2 无选中文本场景（P0 优先级，新增）

- **光标位置上下文（前）**：光标前 500 字符
- **光标位置上下文（后）**：光标后 500 字符
- **记忆库信息**（P1 优先级，可选）：从记忆库获取相关主题、术语、风格信息（如需要）
- **提示词增强**：在提示词中明确要求 AI 自行分析文档主题和结构（如需要）

#### 3.2.3 选择策略

- **优先选择**：与选中文本或光标位置相关的内容
- **边界处理**：优先在段落边界、句子边界截断，保持语义完整性

### 3.3 指令类型识别（P0 优先级，新增）

#### 3.3.1 指令类型分类

**文本修改类**：
- 典型指令："改得更正式"、"翻译成英文"、"润色一下"
- 处理方式：修改文本，保持语义不变，匹配格式和样式

**内容生成类**：
- 典型指令："续写一段"、"生成摘要"、"添加例子"
- 处理方式：生成内容，匹配上下文风格和格式

**分析讨论类**：
- 典型指令："分析这段文字"、"讨论这个观点"、"解释这个概念"
- 处理方式：分析文本，输出分析结果，不修改原文

**匹配查找类**：
- 典型指令："查找类似的表达"、"匹配相关概念"、"检查一致性"
- 处理方式：查找匹配内容，输出匹配结果

#### 3.3.2 指令类型识别方法（优化：通过提示词）

- **提示词增强**：在提示词中明确要求 AI 自行识别指令类型（修改/生成/分析/匹配）
- **关键词辅助**：使用简单关键词匹配作为辅助，但主要依赖 AI 判断
- **动态调整**：根据 AI 识别的指令类型动态调整提示词和处理方式
- **无需独立分析**：不进行独立的 LLM 分析，交由 AI 在提示词指导下自行识别

### 3.4 内容限制（优化后）

#### 3.4.1 输出格式（根据指令类型）

- **修改类**：返回修改后的文本，显示 Diff 视图
- **生成类**：返回生成的内容，直接插入或显示预览
- **分析类**：返回分析结果，以文本形式展示
- **匹配类**：返回匹配结果，以列表或文本形式展示

#### 3.4.2 长度限制

- **动态调整**：根据选中文本长度和指令类型动态调整
- **生成类**：根据上下文和指令要求确定长度
- **分析类**：根据分析深度和内容确定长度

#### 3.4.3 格式和样式匹配（优化）

**格式识别**：
- 自动识别当前文档格式（.txt、.t-docx、.md、.html 等）
- 识别当前位置格式（段落、列表、表格、代码块等）

**格式要求（动态调整）**：
- **格式转换指令**：如果指令要求格式转换（如"转换为 Markdown"），按指令执行
- **保持当前格式**：否则，保持当前文档格式：
  - **TXT 格式**：纯文本，无格式标记
  - **Markdown 格式**：允许 Markdown 语法，与上下文风格一致
  - **t-docx 格式**：匹配 t-docx 样式，保持格式一致性
  - **HTML 格式**：允许 HTML 标签，与上下文风格一致
- **格式约束**：
  - 如果上下文在列表中，输出应保持列表格式
  - 如果上下文在代码块中，输出应保持代码格式（技术文档）
  - 如果上下文有标题层级，输出应匹配层级

#### 3.4.4 模糊指令处理（P0 优先级，新增）

**处理策略**：
- 如果用户指令不明确（如"改好一点"、"优化一下"），请：
  1. 分析上下文，推断用户的合理意图
  2. 基于上下文风格和内容特点，执行合理的优化
  3. 如果无法推断，可以询问用户具体需求（分析讨论场景）

---

## 四、工作逻辑结构

### 4.1 前端工作流程（优化后）

```
用户按下 Cmd+K
    ↓
检测选中文本（可选）
    ↓
显示浮动输入框
    ↓
用户输入指令
    ↓
用户按 Enter 执行
    ↓
提取上下文：
  - 有选中文本：提取选中文本 + 前后各 500 字符
  - 无选中文本：提取光标前后各 500 字符
    ↓
获取记忆库信息（P1 优先级，可选）：
  - 检索相关记忆项（术语、风格偏好、主题信息等）
  - 最多获取 3-5 条相关记忆
    ↓
调用后端 ai_inline_assist（传递指令、上下文、记忆库信息等）
    ↓
显示结果（根据指令类型）：
  - 修改类：显示 Diff 视图
  - 生成类：显示生成内容预览
  - 分析类：显示分析结果
  - 匹配类：显示匹配结果列表
    ↓
用户确认 → 应用到编辑器
用户取消 → 关闭输入框
```

### 4.2 后端工作流程（优化后）

```
接收请求（instruction, text, context, memoryItems）
    ↓
选择 AI 提供商（优先 DeepSeek，其次 OpenAI）
    ↓
构建增强提示词（P0 优先级）：
  - 在提示词中明确要求 AI 自行识别指令类型（修改/生成/分析/匹配）
  - 根据 AI 识别的指令类型动态构建提示词
  - 整合上下文（有/无选中文本）
  - 整合格式信息
  - 整合记忆库信息（术语、风格偏好、主题信息等，如有）
  - 在提示词中明确要求 AI 根据指令类型执行相应操作：
    * 修改类：生成修改后的文本，保持语义不变，匹配格式和样式
    * 生成类：生成新内容，匹配上下文风格和格式
    * 分析类：分析文本，输出分析结果，不修改原文
    * 匹配类：查找匹配内容，输出匹配结果
    ↓
调用 AI 生成结果：
  - AI 根据提示词自行识别指令类型
  - AI 根据指令类型执行相应操作
    ↓
后处理（P0 优先级）：
  - 格式检查（是否符合格式要求）
  - 根据指令类型格式化输出
  - 基本连贯性检查（简单文本匹配，不进行深度语义分析）
    ↓
返回结果（根据指令类型）：
  - 修改类：返回修改后的文本
  - 生成类：返回生成的内容
  - 分析类：返回分析结果
  - 匹配类：返回匹配结果
```

**工作逻辑说明**：
- **静默执行**：层次二的工作过程对用户完全透明，不展示任何中间过程
- **提示词驱动**：通过增强的提示词让 AI 自行识别指令类型，无需独立的技术实现
- **记忆库支持**：充分利用记忆库提供术语、风格偏好、主题信息，减少 AI 分析负担
- **无需工具调用**：层次二不进行工具调用，保持简洁高效
- **结果展示**：根据 AI 识别的指令类型显示相应结果（Diff 视图、生成内容、分析结果、匹配结果）

### 4.3 状态管理

- **Hook 状态**：`useInlineAssist` 管理状态
- **状态字段**：`isVisible`（是否可见）、`instruction`（指令）、`selectedText`（选中文本）、`diff`（Diff 结果）、`isLoading`（是否加载中）、`error`（错误信息）
- **状态更新**：响应用户操作和 AI 响应

---

## 五、UI 实现

### 5.1 输入框组件

- **位置**：在选中文本下方或光标位置附近
- **样式**：浮动输入框，带边框和阴影
- **内容**：单行输入框 + 执行按钮 + 取消按钮
- **选中文本预览**：显示选中的文本预览（如果有）

### 5.2 结果展示（根据指令类型）

**修改类**：
- **Diff 视图**：显示修改前后的对比（红删绿增）
- **交互**：用户确认后应用，取消则不应用

**生成类**：
- **内容预览**：显示生成的内容预览
- **交互**：用户确认后插入，取消则不插入

**分析类**：
- **分析结果**：以文本形式展示分析结果
- **交互**：用户可复制或关闭

**匹配类**：
- **匹配结果**：以列表或文本形式展示匹配结果
- **交互**：用户可查看详情或关闭

### 5.3 交互操作

- **Enter 键**：执行指令
- **Esc 键**：取消操作
- **接受修改**：用户确认后应用 AI 建议
- **拒绝修改**：用户取消，不应用建议

---

## 六、性能要求

### 6.1 响应时间

- **目标**：< 5 秒（从提交到显示结果）
- **优化策略**：使用标准模型、优化提示词、流式显示（可选）

### 6.2 资源占用

- **内存占用**：< 20MB
- **CPU 占用**：< 30%（AI 处理时）

### 6.3 流式显示（待优化）

- **当前状态**：一次性返回结果
- **优化方向**：支持逐步显示 AI 生成内容，提升用户体验
- **智能 Chunk 分割**（如实现流式显示）：
  - 按句子边界分割（句号、问号、感叹号等），避免在单词中间分割
  - 支持 offset 跟踪，避免重复解析
  - 提升流式显示的流畅度和可读性

---

## 七、错误处理

### 7.1 错误类型

- **网络错误**：连接失败、超时
- **API 错误**：API Key 无效、配额不足
- **解析错误**：响应格式错误
- **错误级别分类**：
  - **Error**：严重错误（API Key 无效、网络连接失败）
  - **Warning**：警告信息（配额不足、响应超时）
  - **Info**：提示信息（响应被过滤、部分内容未返回）

### 7.2 处理策略

- **错误提示优化**：在输入框中显示友好的错误提示
  - 不同错误级别采用不同的提示样式（Error 红色、Warning 黄色、Info 蓝色）
  - 提供具体的错误原因和解决建议
  - 提供错误恢复操作（重试、取消等）
- **自动重试**：网络错误自动重试（最多 3 次，指数退避）
- **用户操作**：提供"重试"按钮，用户可手动重试
- **错误详情扩展**：
  - 检测响应是否不完整
  - 检测配额是否超限
  - 提供更详细的错误信息

---

## 八、配置选项

### 8.1 可配置项（优化后）

- **快捷键**：Cmd+K / Ctrl+K（可配置）
- **上下文长度**：选中文本前后各 500 字符（可配置）
- **是否显示 Diff**：可配置是否显示 Diff 视图（修改类）
- **指令类型识别**：是否启用指令类型自动识别（P0 优先级，默认启用）
- **文档整体信息**：是否提取文档整体信息（P1 优先级，默认关闭）

### 8.2 模型选择

- **优先模型**：DeepSeek Chat（标准模型）
- **备用模型**：OpenAI GPT-4
- **选择策略**：使用标准模型，保证质量

---

## 九、边界情况处理

### 9.1 特殊场景（优化后）

- **无选中文本**：在光标位置执行指令（P0 优先级，已支持）
  - 支持生成类指令（如"生成一段介绍"）
  - 支持分析类指令（如"分析当前文档"）
- **选中文本过长**：自动截断或提示用户
- **指令为空**：不允许执行，提示用户输入指令
- **指令类型无法识别**：使用默认处理方式（修改类）
- **模糊指令**：基于上下文推断合理意图（P0 优先级）
- **编辑器未打开**：不显示输入框

### 9.2 冲突处理

- **快捷键冲突**：Cmd+K 与其他功能冲突时优先 Inline Assist
- **多光标**：暂不支持多光标场景
- **只读模式**：只读文档可查看 Diff，但不应用修改

---

## 十、技术实现细节

### 10.1 前端实现

- **Hook**：`useInlineAssist.ts`
- **组件**：`InlineAssistInput.tsx`
- **位置计算**：`InlineAssistPosition.tsx`（可选）

### 10.2 后端实现

- **命令**：`ai_inline_assist`
- **服务**：`AIService::inline_assist`
- **提供商**：`DeepSeekProvider`、`OpenAIProvider`

### 10.3 数据流

```
快捷键触发 → useInlineAssist Hook → 显示输入框 → 用户输入指令 → 后端 ai_inline_assist → AI 服务 → 返回结果 → 显示 Diff（可选） → 应用到编辑器
```

---

## 十一、Diff 视图实现

### 11.1 Diff 计算

- **算法**：简单的文本对比算法（可优化为更精确的算法）
- **显示方式**：红删绿增，对比修改前后
- **粒度**：字符级别或单词级别

### 11.2 Diff 视图组件

- **组件**：`DiffView.tsx`（已存在，可复用）
- **交互**：确认/取消按钮
- **预览**：修改前预览，确认后应用

---

## 十二、测试要点

### 12.1 功能测试

- 快捷键触发测试
- 指令执行测试
- Diff 视图测试
- 边界情况测试

### 12.2 性能测试

- 响应时间测试
- 资源占用测试
- 大文本处理测试

---

## 十三、后续优化方向（基于分析文档）

### 13.1 功能优化（按优先级）

#### 13.1.1 P0 优先级（高优先级，必须实现）

- ✅ **提示词驱动的指令类型识别**：通过提示词让 AI 自行识别指令类型（修改/生成/分析/匹配）
- ✅ **无选中文本支持**：支持无选中文本的场景
- ✅ **格式适配优化**：根据文档格式和场景动态调整
- ✅ **模糊指令处理**：通过提示词让 AI 基于上下文推断合理意图
- ✅ **记忆库集成**：充分利用记忆库提供术语、风格偏好、主题信息

#### 13.1.2 P1 优先级（中优先级，建议实现）

- ⚠️ **上下文增强**：增加文档整体信息（主题、结构）
- ⚠️ **风格识别**：识别文档风格，保持一致性
- ⚠️ **语义分析**：提取关键实体、主题，提升理解准确性
- ⚠️ **Diff 视图优化**：更精确的差异对比算法
- ⚠️ **流式显示**：支持逐步显示 AI 生成内容

#### 13.1.3 P2 优先级（低优先级，可选实现）

- 📋 **记忆库跨文档支持**：通过记忆库支持跨文档查找和匹配
- 📋 **记忆库知识管理**：优化记忆库中的知识管理，支持分析讨论场景引用
- 📋 **用户偏好学习**：将用户的指令偏好保存到记忆库，根据偏好调整提示词

### 13.2 性能优化

- **响应时间优化**：目标 < 5 秒（从提交到显示结果）
- **大文本处理优化**：优化大文本的处理效率
- **上下文提取优化**：提高上下文提取和处理的效率
- **指令类型识别优化**：提高指令类型识别的准确性和速度

### 13.3 实施建议

**第一阶段（P0）**：
- 实现提示词驱动的指令类型识别
- 支持无选中文本场景
- 优化格式适配
- 处理模糊指令
- 集成记忆库支持

**第二阶段（P1）**：
- 优化记忆库检索算法
- 优化提示词，让 AI 自行分析主题、结构、风格
- 优化 Diff 视图和流式显示

**第三阶段（P2）**：
- 通过记忆库支持跨文档匹配
- 优化记忆库知识管理
- 用户偏好学习

---

**文档版本**：v1.0  
**创建日期**：2025年  
**维护者**：Binder 开发团队

