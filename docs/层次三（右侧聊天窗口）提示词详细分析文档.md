# 层次三（右侧聊天窗口）提示词详细分析文档

## 文档信息

- **文档版本**：v1.0
- **创建日期**：2025年
- **文档性质**：提示词工程分析文档
- **适用范围**：Binder 层次三（右侧聊天窗口）功能提示词优化

## 格式说明

**重要**：本文档中提到的文档格式说明：
- **原生 DOCX**：Word 原生的 .docx 文件，Binder 只能预览，不能编辑
- **t-docx**：Binder 可编辑的文档格式（TipTap 模拟的 DOCX），包括：
  - Binder 生成的文档
  - 从预览模式切换到编辑模式时创建的草稿文件（如 `document.draft.docx`）
  - 所有在 Binder 编辑器中可编辑的文档

本文档中所有涉及"可编辑"、"格式匹配"、"样式继承"等场景下的 DOCX，均指 **t-docx** 格式。

---

## 一、当前提示词设计回顾

### 1.1 多层提示词架构

层次三采用**四层提示词架构**：
- **第一层**：基础系统提示词（角色定义、行为规范、工作规划要求）
- **第二层**：上下文提示词（当前文档、编辑器状态、工作区信息、格式样式）
- **第三层**：引用提示词（用户引用的内容）
- **第四层**：工具调用提示词（仅 Agent 模式，工具规范、JSON 格式要求）

### 1.2 当前设计的优点

- **架构清晰**：多层提示词架构层次分明
- **上下文丰富**：包含文档、编辑器、工作区等多种上下文信息
- **引用完整**：引用内容完整传递，避免重复读取
- **工具规范**：工具调用规范明确，包含 JSON 格式要求

### 1.3 当前设计的不足

- **工作规划逻辑不清晰**：何时需要规划、何时直接执行不明确
- **JSON 规范重复**：在多个位置重复强调 JSON 格式要求
- **引用提示词冗长**：对每种引用类型都单独说明，过于啰嗦
- **格式匹配要求冗长**：格式说明在每层都重复，可以精简
- **文档内容预览规则不明确**：智能选择规则不够具体

---

## 二、层次三功能特性分析

### 2.1 核心特性

**多轮对话**：
- 支持多轮对话，保持上下文
- 对话历史作为上下文传递
- 需要保持对话连贯性

**模式区分**：
- **Agent 模式**：可以调用工具执行操作
- **Chat 模式**：仅对话，不调用工具
- 两种模式的提示词需要区分

**工作规划展示**：
- Agent 模式需要展示工作规划
- 需要明确何时需要规划、何时直接执行
- 规划需要用户确认后执行

**工具调用**：
- 支持文件操作、编辑器操作、网络搜索等
- 工具调用需要 JSON 格式规范
- 需要处理工具调用的错误和重试

### 2.2 使用场景分类

#### 2.2.1 简单对话场景

**典型场景**：
- 咨询问题、获取建议
- 讨论文档内容
- 获取技术指导

**需求特点**：
- 不需要工具调用
- 不需要工作规划
- 直接回答即可

**当前提示词问题**：
- ❌ Agent 模式默认要求工作规划，简单问题也会触发规划
- ❌ 工具调用规范对 Chat 模式不适用，但仍会传递

#### 2.2.2 复杂任务场景

**典型场景**：
- 分析多个文件
- 创建项目结构
- 执行多步骤操作

**需求特点**：
- 需要读取多个文件
- 需要规划执行步骤
- 需要工具调用链

**当前提示词问题**：
- ❌ 工作规划要求过于理想化，AI 可能不知道何时该规划
- ❌ 规划生成后"等待用户确认"的机制不明确

#### 2.2.3 文档修改场景

**典型场景**：
- 修改当前文档
- 批量修改多个文档
- 格式化文档

**需求特点**：
- 需要匹配文档格式和样式
- 需要用户确认修改
- 需要显示 Diff 视图

**当前提示词问题**：
- ❌ 格式匹配要求过于冗长，在多个位置重复
- ❌ 样式继承规则不明确

#### 2.2.4 信息查询场景

**典型场景**：
- 查询工作区文件
- 搜索网络信息
- 查找相关内容

**需求特点**：
- 需要工具调用（read_file、web_search 等）
- 需要处理查询结果
- 需要格式化输出

**当前提示词问题**：
- ❌ 工具调用规范重复，影响提示词效率
- ❌ 查询结果的格式化要求不明确

---

## 三、提示词优化建议

### 3.1 系统提示词优化

#### 3.1.1 Agent 模式系统提示词

**当前问题**：
- 工作规划要求过于理想化
- JSON 规范重复出现
- 何时需要规划不明确

**优化后**：
```
你是一个专业的编程助手和文档编辑助手。

你可以帮助用户：
- 回答编程和文档相关的问题
- 执行文件操作（读取、创建、更新、删除文件等）
- 执行编辑器操作（修改文档内容等）
- 搜索和浏览网络信息（如需要外部信息）

工作模式：
你可以访问以下工具：[工具列表]

执行流程：
1. **判断是否需要规划**：
   - 如果任务需要读取多个文件（3个以上）或浏览网站，先调用 plan_workflow 工具生成规划
   - 对于简单任务（读取1-2个文件、修改文档等），直接调用相关工具
   - 规划生成后会展示给用户确认，确认后继续执行

2. **何时需要规划**：
   - ✅ "帮我分析项目中所有配置文件的差异" → 需要规划
   - ❌ "读取 config.json 并解释其作用" → 直接执行
   - ✅ "根据 requirements.txt 创建项目文档" → 需要规划（涉及多步骤）

3. **工具调用格式要求（CRITICAL）**：
   所有工具调用必须使用严格的 JSON 格式：
   ```json
   {"tool":"tool_name","arguments":{"key":"value"}}
   ```
   
   常见错误：
   - ❌ {tool:read_file,arguments:{path:test.md}}  // 缺少引号
   - ❌ {"tool":"read_file","arguments":{"path":test.md}}  // 值缺少引号
   - ✅ {"tool":"read_file","arguments":{"path":"test.md"}}
   
   规则：
   - 所有键名必须用双引号包裹
   - 所有字符串值必须用双引号包裹
   - JSON 必须完整闭合，以 } 结尾
   - 确保 JSON 格式完全正确，可以被 JSON.parse() 解析
```

#### 3.1.2 Chat 模式系统提示词

**当前**：较为合理，无需大幅修改

**优化建议**：
- 精简格式匹配要求
- 明确快捷应用到文档的说明

### 3.2 上下文提示词优化

#### 3.2.1 文档内容预览规则

**当前问题**：
- 智能选择规则不够明确
- 未考虑用户消息类型

**优化后**：
```
文档内容预览选择规则（智能选择）：
- 如果用户消息提到文档某部分（如"第三章"、"开头部分"），优先包含该部分
- 如果用户询问整体问题（如"总结文档"、"文档主题"），包含文档开头 + 结构大纲
- 如果用户追问具体细节，包含光标位置附近内容（前后各 400 字符）
- 如果文档有标题结构，优先包含当前段落所在章节的内容
- 如果光标位置内容不足，补充文档开头内容
```

#### 3.2.2 格式匹配要求精简

**当前问题**：
- 格式说明在多个位置重复
- 过于冗长，影响提示词效率

**优化后**：
```
格式匹配要求：
生成内容需匹配当前 [格式] 的样式规范，保持与文档一致的格式和风格。
```

**详细规则**：放入设计文档，不在提示词中重复

### 3.3 引用提示词优化

**当前问题**：
- 对每种引用类型都单独说明"已完整包含，无需再读取"
- 过于冗长

**优化后**：
```
[用户引用内容]

以下内容由用户主动引用，已完整传递，请直接使用：

1. 文本引用（来源：[文件路径] 第 [行号范围] 行）
[引用的文本内容]

2. 文件引用（来源：[文件路径]）
[文件的完整内容]

3. 文件夹引用（来源：[文件夹路径]）
[文件夹中所有文件的列表和内容]

4. 图片引用（来源：[图片路径]）
[图片描述或说明]

5. 记忆库引用（来源：记忆库 - [记忆库名称]）
[记忆项内容]

6. 聊天记录引用（来源：[标签页名称]，消息 1-3，[时间戳]）
[聊天记录内容，包含标签页标题、消息角色、消息内容、时间戳]

7. 链接引用（来源：[URL]）
[链接描述]

注意：这些内容无需通过 read_file 工具再次读取。
```

### 3.4 工具调用提示词优化

**当前问题**：
- JSON 规范在系统提示词中已说明，工具调用提示词中不应重复

**优化后**：
```
工具调用格式：
```json
{
  "tool": "工具名称",
  "arguments": {
    "参数名": "参数值"
  }
}
```

注意：JSON 格式规范已在系统提示词中说明，此处不再重复。
```

---

## 四、工作规划逻辑优化

### 4.1 规划触发条件

**明确规则**：
- **需要规划**：读取3个以上文件、浏览网站、多步骤任务
- **直接执行**：读取1-2个文件、修改文档、简单查询

**实现方式**：
- 在系统提示词中明确说明
- 通过示例帮助 AI 理解

### 4.2 规划确认机制

**当前问题**：
- "等待用户确认"的机制不明确
- AI 无法主动暂停

**优化方案**：
- 通过工具返回值实现确认机制
- `plan_workflow` 工具返回后，前端展示规划
- 用户确认后，继续执行后续工具调用
- 在提示词中说明："规划生成后会展示给用户确认，确认后继续执行"

### 4.3 执行步骤展示

**优化建议**：
- 在提示词中明确步骤状态的含义
- 明确工具调用的执行顺序
- 明确步骤之间的依赖关系

---

## 五、多轮对话优化

### 5.1 对话连贯性

**问题**：
- 长对话历史可能导致上下文过长
- 需要保持对话主题一致性

**优化建议**：
- 在提示词中强调保持对话连贯性
- 明确对话历史的处理方式
- 支持对话摘要（P1 优先级）

### 5.2 上下文管理

**问题**：
- 多轮对话中，上下文信息可能重复
- 需要智能管理上下文长度

**优化建议**：
- 动态调整上下文长度
- 优先保留最近的对话和关键信息
- 支持上下文压缩（P1 优先级）

---

## 六、格式和样式匹配优化

### 6.1 格式识别

**当前实现**：
- 自动识别文档格式
- 在提示词中传递格式信息

**优化建议**：
- 精简格式说明，详细规则放入文档
- 在提示词中只保留核心要求

### 6.2 样式继承

**问题**：
- 样式继承规则不明确
- 快捷应用到文档时需要样式继承

**优化建议**：
- 在提示词中明确样式继承规则
- 明确光标位置样式的获取方式

---

## 七、优化后的提示词结构

### 7.1 Agent 模式完整提示词

```
[系统提示词]
你是一个专业的编程助手和文档编辑助手。

你可以帮助用户：
- 回答编程和文档相关的问题
- 执行文件操作（读取、创建、更新、删除文件等）
- 执行编辑器操作（修改文档内容等）
- 搜索和浏览网络信息（如需要外部信息）

工作模式：
你可以访问以下工具：[工具列表]

执行流程：
1. 判断是否需要规划（读取3个以上文件或浏览网站 → 需要规划）
2. 对于简单任务，直接调用相关工具
3. 规划生成后会展示给用户确认，确认后继续执行

工具调用格式要求（CRITICAL）：
[统一的 JSON 格式说明，仅在此处出现一次]

[上下文提示词]
[当前文档信息、编辑器状态、工作区信息]
格式匹配要求：生成内容需匹配当前 [格式] 的样式规范。

[引用提示词]
[精简的引用内容格式，统一说明"无需再读"]

[工具调用提示词]
[工具列表和说明，不重复 JSON 规范]
```

### 7.2 Chat 模式完整提示词

```
[系统提示词]
你是一个专业的编程助手和文档编辑助手。
你可以帮助用户：
- 回答编程和文档相关的问题
- 提供技术建议和最佳实践
- 分析和讨论代码和文档内容
- 提供格式化和样式建议

请以友好、专业的方式回答用户的问题。

[上下文提示词]
[当前文档信息、编辑器状态、工作区信息]
格式匹配要求：生成内容需匹配当前 [格式] 的样式规范。

[引用提示词]
[精简的引用内容格式，统一说明"无需再读"]

注意：Chat 模式不支持工具调用，如需执行操作，请切换到 Agent 模式。
```

---

## 八、优化优先级

### 8.1 P0 优先级（必须实现）

- ✅ **工作规划逻辑优化**：明确何时需要规划、何时直接执行
- ✅ **JSON 规范去重**：统一在系统提示词末尾说明一次
- ✅ **引用提示词精简**：合并"无需再读"说明，使用精简格式
- ✅ **格式匹配要求精简**：精简为"匹配当前 [格式] 的样式规范"

### 8.2 P1 优先级（建议实现）

- ⚠️ **文档内容预览规则优化**：根据用户消息类型智能选择
- ⚠️ **对话连贯性优化**：保持对话主题一致性
- ⚠️ **上下文管理优化**：动态调整上下文长度
- ⚠️ **样式继承规则明确**：明确样式继承的具体规则

### 8.3 P2 优先级（可选实现）

- 📋 **对话摘要**：长对话历史自动摘要
- 📋 **上下文压缩**：智能压缩上下文，保留关键信息
- 📋 **个性化提示词**：根据用户偏好调整提示词

---

## 九、总结

### 9.1 核心优化点

1. **工作规划逻辑清晰化**：明确何时需要规划、何时直接执行，通过示例帮助 AI 理解
2. **JSON 规范去重**：统一在系统提示词末尾说明一次，避免重复
3. **引用提示词精简**：合并"无需再读"说明，使用精简格式（序号 + 类型 + 来源）
4. **格式匹配要求精简**：精简为"匹配当前 [格式] 的样式规范"，详细规则放入文档
5. **文档内容预览规则优化**：根据用户消息类型智能选择内容

### 9.2 实施建议

**第一阶段（P0）**：
- 优化工作规划逻辑
- 去重 JSON 规范
- 精简引用提示词
- 精简格式匹配要求

**第二阶段（P1）**：
- 优化文档内容预览规则
- 优化对话连贯性
- 优化上下文管理
- 明确样式继承规则

**第三阶段（P2）**：
- 实现对话摘要
- 实现上下文压缩
- 实现个性化提示词

---

**文档版本**：v1.0  
**创建日期**：2025年  
**最后更新**：2025年  
**维护者**：Binder 开发团队

