# 工具调用 JSON 解析失败问题分析

## 问题描述

从终端日志可以看到，AI 尝试调用 `update_file` 工具时，JSON 参数解析失败：

```
⚠️ 工具调用参数 JSON 解析失败: EOF while parsing a string at line 1 column 9996
🔧 尝试修复 JSON（添加闭合括号）: {...}
❌ JSON 修复失败，使用空对象（工具调用将失败）
⚠️ 继续对话中工具执行失败（第 1 次尝试）: update_file - 缺少 path 参数
```

## 根本原因分析

### 1. JSON 字符串值未正确转义

当 `update_file` 工具的 `content` 参数包含大量文本时，其中的特殊字符（换行符、引号、反斜杠等）需要正确转义为：
- `\n` (换行符)
- `\"` (引号)
- `\\` (反斜杠)

如果 AI 生成的 JSON 中，字符串值包含未转义的换行符，JSON 解析器会认为字符串在换行符处结束，导致 `EOF while parsing a string` 错误。

### 2. 流式传输中的 JSON 截断

虽然代码在 `deepseek.rs` 中检查了 JSON 是否完整（以 `}` 结尾且能成功解析），但在某些情况下：
- JSON 字符串值在流式传输中被截断
- 字符串值未闭合，但外层 JSON 结构看起来完整（以 `}` 结尾）
- 检查通过，但实际解析时失败

### 3. JSON 修复逻辑不足

当前的修复逻辑（`repair_json_arguments` 和 `parse_tool_arguments`）只处理了：
- ✅ 缺少闭合括号
- ✅ 键名缺少引号

但没有处理：
- ❌ 字符串值中的转义问题
- ❌ 字符串值未闭合的问题
- ❌ 从部分 JSON 中提取可用信息（如 `path` 参数）

## 问题影响

1. **工具调用失败**：修复失败后使用空对象，导致 `path` 参数丢失
2. **用户体验差**：AI 尝试更新文件，但工具调用失败，用户看不到明确的错误信息
3. **功能不可用**：`update_file` 工具在写入大文件时无法正常工作

## 解决方案

### 方案 1：改进 JSON 修复逻辑（推荐）

增强 `repair_json_arguments` 和 `parse_tool_arguments` 函数，处理字符串转义和未闭合问题：

1. **检测未闭合的字符串值**：
   - 统计字符串中的引号数量（考虑转义）
   - 如果字符串值未闭合，尝试添加闭合引号

2. **修复字符串转义**：
   - 检测字符串值中的未转义换行符
   - 将未转义的换行符替换为 `\n`

3. **部分 JSON 提取**：
   - 如果修复失败，尝试从部分 JSON 中提取可用字段（如 `path`）
   - 至少保证工具调用有基本的参数

### 方案 2：增强 JSON 完整性检查

在 `deepseek.rs` 中，更严格地检查 JSON 完整性：
- 不仅检查是否以 `}` 结尾
- 还要检查字符串值是否闭合（引号配对）
- 检查字符串值中的转义是否正确

### 方案 3：限制工具调用参数大小

对于 `update_file` 等工具，如果 `content` 参数过大：
- 提示 AI 使用其他方式（如分段写入）
- 或者限制单个工具调用的参数大小

## 实施建议

1. **短期**：改进 JSON 修复逻辑，处理字符串转义和未闭合问题 ✅ 已完成
2. **中期**：增强 JSON 完整性检查，在流式传输中更严格地验证 ✅ 已完成
3. **长期**：考虑限制工具调用参数大小，或提供分段写入机制

## 已实施的修复

### 1. 改进 JSON 修复逻辑 ✅

**文件**：`src-tauri/src/services/tool_call_handler.rs`

- 新增 `repair_json_string` 函数：处理字符串值中的未转义换行符、制表符等
- 新增 `extract_partial_json` 函数：当修复失败时，尝试从部分 JSON 中提取可用字段（如 `path`）
- 改进 `parse_tool_arguments` 函数：使用增强的修复逻辑

**关键改进**：
- 检测并修复字符串值中的未转义换行符（`\n` → `\\n`）
- 处理 `\r\n` 和单独的 `\r`
- 转义制表符（`\t` → `\\t`）
- 如果修复失败，尝试提取 `path` 等关键字段，避免完全失败

### 2. 增强 JSON 完整性检查 ✅

**文件**：`src-tauri/src/services/ai_providers/deepseek.rs`

- 增强 JSON 完整性检查逻辑（第 682-704 行）
- 不仅检查是否以 `}` 结尾，还检查：
  - 括号是否匹配（`{` 和 `}` 数量相等）
  - 引号是否成对（简单检查：引号数量是否为偶数）
  - JSON 是否能成功解析

**关键改进**：
- 多维度验证 JSON 完整性，减少误判
- 提供详细的检查日志，便于调试

### 3. 改进 JSON 修复函数 ✅

**文件**：`src-tauri/src/commands/ai_commands.rs`

- 新增 `repair_json_string_escapes` 函数：专门处理字符串转义问题
- 改进 `repair_json_arguments` 函数：在原有修复基础上，增加字符串转义处理

**关键改进**：
- 在字符串值内部，将未转义的换行符替换为 `\n`
- 处理 `\r\n` 和单独的 `\r`
- 转义制表符

## 测试建议

1. **测试场景 1**：AI 尝试更新包含大量换行符的文件
   - 预期：JSON 解析成功，工具调用成功

2. **测试场景 2**：JSON 在流式传输中被截断
   - 预期：系统能够检测到不完整的 JSON，继续累积直到完整

3. **测试场景 3**：JSON 修复失败
   - 预期：系统能够从部分 JSON 中提取 `path` 等关键字段，至少保证基本功能

## 后续优化方向

1. **更智能的字符串提取**：改进 `extract_partial_json` 函数，支持提取更多字段
2. **限制工具调用参数大小**：对于 `update_file` 等工具，如果 `content` 过大，提示 AI 使用其他方式
3. **分段写入机制**：对于大文件，提供分段写入的工具或机制

## 相关代码位置

- `src-tauri/src/commands/ai_commands.rs`：`repair_json_arguments` 函数（第 82-133 行）
- `src-tauri/src/services/tool_call_handler.rs`：`parse_tool_arguments` 函数（第 72-106 行）
- `src-tauri/src/services/ai_providers/deepseek.rs`：JSON 完整性检查（第 678-680 行）

