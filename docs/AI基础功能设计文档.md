# Binder AI 基础功能设计文档

## 文档信息

- **文档版本**：v1.0
- **创建日期**：2025年
- **文档性质**：技术设计文档
- **适用范围**：Binder 应用的所有 AI 功能基础机制

## 格式说明

**重要**：本文档中提到的文档格式说明：
- **原生 DOCX**：Word 原生的 .docx 文件，Binder 只能预览，不能编辑
- **t-docx**：Binder 可编辑的文档格式（TipTap 模拟的 DOCX），包括：
  - Binder 生成的文档
  - 从预览模式切换到编辑模式时创建的草稿文件（如 `document.draft.docx`）
  - 所有在 Binder 编辑器中可编辑的文档

本文档中所有涉及"可编辑"、"格式匹配"、"样式继承"等场景下的 DOCX，均指 **t-docx** 格式。

---

## 一、文档目的

明确 AI 在 Binder 中的通用工作机制，包括信息获取、AI 调用、结果处理等基础流程，为各层 AI 功能提供统一的技术基础。

---

## 二、AI 在 Binder 中的工作流程

### 2.1 整体工作流程

```
用户操作/触发
    ↓
上下文信息收集
    ↓
提示词构建
    ↓
AI 服务调用
    ↓
响应处理
    ↓
结果应用到编辑器/文档
```

### 2.2 关键环节说明

- **上下文信息收集**：从编辑器、工作区、用户操作中收集相关信息
- **提示词构建**：根据功能类型和上下文构建合适的提示词
- **AI 服务调用**：通过统一的 AI 服务接口调用 AI 模型
- **响应处理**：处理 AI 返回的结果（文本、工具调用等）
- **结果应用**：将处理后的结果应用到编辑器或文档

---

## 三、信息获取机制

### 3.1 上下文信息来源

1. **编辑器状态**（隐式上下文，自动检测）
   - 当前打开的文档路径
   - 文档内容（全文或部分）
   - 光标位置
   - 选中文本
   - 编辑器状态（只读/可编辑、文件类型、文件大小、是否已保存）
   - **隐式上下文检测**：系统自动检测当前编辑器上下文，无需用户主动引用
     - 自动包含当前文档内容（智能选择关键部分）
     - 自动包含光标位置和选中文本
     - 自动包含编辑器状态信息
     - 提升用户体验，减少用户操作

2. **工作区信息**
   - 工作区根目录路径
   - 工作区文件结构
   - 当前工作区上下文
   - **上下文索引**（大工作区优化）：建立工作区文件索引，快速检索相关上下文
     - 文件内容索引（关键词、符号等）
     - 快速相关性评分
     - 智能选择最相关的文件作为上下文

3. **用户操作信息**（显式引用）
   - 用户输入/指令
   - 引用内容（文本、文件、文件夹、图片、聊天记录等）
   - 操作历史（部分功能）

4. **记忆库信息**（重要信息来源）
   - **角色定位**：记忆库作为长期上下文存储，用于保存和检索重要信息
   - **信息来源**：是重要的上下文信息来源，特别是长文档场景
   - **使用方式**：
     - **自动检索**：根据当前对话主题自动检索相关记忆项
     - **用户引用**：用户可以通过 `@记忆库名称` 主动引用记忆项
     - **智能匹配**：AI 可以根据对话内容智能匹配相关记忆
   - **记忆项类型**：
     - 文档关键信息摘要
     - 项目配置和约定
     - 用户偏好和习惯
     - 重要对话摘要
   - **传递方式**：作为引用提示词的一部分传递给 AI，明确标注为"记忆库信息"

5. **聊天记录信息**（当前对话上下文）
   - **当前标签页聊天记录**：自动作为对话历史传递给 AI
   - **跨标签页聊天记录**：通过用户主动引用（引用其他标签页的聊天内容）
   - **使用方式**：
     - **自动包含**：当前标签页的对话历史自动包含在上下文中
     - **用户引用**：用户可以通过复制粘贴、拖拽等方式引用其他标签页的聊天记录
     - **智能检索**：根据对话主题智能检索相关历史对话（可选功能）
   - **传递方式**：作为消息历史传递给 AI，或作为引用提示词的一部分

6. **互联网信息**（通过工具调用获取）
   - **获取方式**：通过 AI 工具调用（Agent 模式）获取外部信息
   - **工具类型**：
     - `web_search`：网络搜索工具（搜索互联网信息）
     - `browse_website`：浏览网页工具（获取网页内容）
     - `fetch_url`：获取 URL 内容工具（获取特定 URL 的内容）
   - **使用场景**：
     - 查询最新信息、技术文档、API 文档等
     - 获取实时数据、新闻、市场信息等
     - 查找代码示例、最佳实践等
   - **处理流程**：
     ```
     AI 识别需要外部信息
         ↓
     调用 web_search 或 browse_website 工具
         ↓
     获取互联网内容
         ↓
     将内容添加到对话上下文
         ↓
     继续对话或生成回答
     ```
   - **注意事项**：
     - 仅在 Agent 模式下可用（需要工具调用支持）
     - 需要用户明确授权（首次使用时）
     - 网络请求可能失败，需要错误处理
     - 获取的内容需要验证和过滤（避免恶意内容）

### 3.2 上下文信息选择策略

- **智能选择**：根据功能类型和场景选择最相关的上下文
- **内容预览**：大文档时智能选择关键部分（如光标附近内容）
- **长度限制**：控制上下文长度，避免超出模型限制
- **记忆库检索**：根据对话主题自动检索相关记忆项（最多 3-5 条相关记忆）
- **聊天历史选择**：长对话历史时，优先选择最近的对话和关键对话节点
- **上下文索引优化**（大工作区场景）：
  - 建立文件内容索引，快速检索相关上下文
  - 上下文相关性评分，优先选择最相关的文件
  - 索引缓存机制，提升检索性能

### 3.3 上下文信息传递

- **统一格式**：所有上下文信息通过统一的格式传递给 AI
- **分层构建**：根据功能类型分层构建上下文（系统提示词、上下文提示词、引用提示词等）
- **信息分类标注**：明确标注信息来源（编辑器状态、工作区信息、记忆库、聊天记录、互联网信息等）
- **优先级排序**：根据信息重要性排序（用户引用 > 当前文档 > 记忆库 > 聊天历史 > 互联网信息）

---

## 四、AI 工作规划和执行逻辑

### 4.1 工作规划机制

**核心概念**：AI 在接收到用户指令后，可以自动规划工作流程，包括：
- **资源识别**：自动识别需要读取的文档、需要浏览的网站
- **步骤规划**：分步安排工作（读取文档 → 分析内容 → 生成文件 → 创建文件夹等）
- **工具选择**：根据任务需求自动选择合适的工具（文件操作、网络搜索、编辑器操作等）

**工作流程**：
```
用户发出指令
    ↓
AI 分析任务需求
    ↓
自动规划工作步骤：
  1. 识别需要读取的文档（工作区文件、引用文件等）
  2. 识别需要浏览的网站（如需要外部信息）
  3. 规划执行步骤（读取 → 分析 → 生成 → 创建等）
  4. 选择需要的工具（read_file、web_search、create_file 等）
    ↓
分步执行工作流程
    ↓
返回最终结果
```

### 4.2 隐式上下文自动收集

**自动资源识别**：
- **工作区文件扫描**：根据任务需求，自动扫描工作区相关文件
- **文件相关性评分**：根据文件名、路径、内容相关性评分，选择最相关的文件
- **网络资源识别**：如果任务需要外部信息，自动识别需要访问的网站
- **上下文变量系统**：建立统一的上下文变量服务，支持隐式和显式变量

**资源选择策略**：
- **优先级排序**：用户引用 > 当前文档 > 工作区相关文件 > 记忆库 > 网络资源
- **智能过滤**：自动过滤不相关的文件，减少上下文长度
- **批量处理**：支持批量读取多个文件，提升效率

### 4.3 分步执行机制

**执行步骤管理**：
- **步骤规划**：AI 生成执行计划，包含多个步骤
- **步骤状态**：每个步骤有状态（pending、executing、completed、failed）
- **步骤依赖**：支持步骤之间的依赖关系（步骤2依赖步骤1的结果）
- **步骤取消**：支持取消正在执行的步骤

**工具调用链**：
- **工具注册表**：统一的工具注册和发现机制
- **工具权限控制**：不同工具有不同的权限要求（只读、读写、危险操作）
- **工具调用上下文**：传递会话ID、请求ID等上下文信息
- **工具调用取消**：支持按 requestId 取消工具调用

### 4.4 工作过程展示策略

**展示模式**：
- **层次一（自动补全）**：静默执行，不展示工作过程
  - AI 自动规划和执行，用户无感知
  - 只显示最终结果（幽灵文字）
- **层次二（Inline Assist）**：静默执行，不展示工作过程
  - AI 自动规划和执行，用户无感知
  - 只显示最终结果（Diff 视图）
- **层次三（聊天窗口）**：完整展示工作过程
  - 展示工作规划（需要读取哪些文档、访问哪些网站）
  - 展示分步执行过程（每个步骤的状态和结果）
  - 展示工具调用详情（工具名称、参数、结果）
  - 提供进度反馈和取消功能

---

## 五、AI 服务调用机制

### 5.1 AI 服务架构

- **统一服务接口**：`AIService` 提供统一的 AI 调用接口
- **多提供商支持**：支持 OpenAI、DeepSeek 等（可扩展）
- **模型管理**：统一的模型配置和选择机制

### 5.2 请求构建

- **提示词构建**：根据功能类型和上下文构建提示词
- **参数配置**：温度、最大 Token、超时等参数配置
- **请求格式**：统一的请求格式（消息列表、工具定义等）
- **文档格式和样式匹配**（重要）：
  - **格式识别**：自动识别当前编辑文档的格式（.txt、.t-docx、.md、.html 等）
  - **样式匹配**：根据文档格式匹配相应的样式要求
    - **TXT 格式**：纯文本样式，无格式标记，保持简洁
    - **t-docx 格式**：支持富文本样式（标题、粗体、斜体、列表、段落对齐等），匹配 t-docx 的样式规范
    - **Markdown 格式**：支持 Markdown 语法（标题、列表、代码块、链接等）
    - **HTML 格式**：支持 HTML 标签和样式
  - **提示词增强**：在提示词中明确说明当前文档格式和样式要求
  - **输出格式控制**：确保 AI 生成的内容符合当前文档格式的样式规范

### 5.3 请求执行

- **同步/异步**：根据功能类型选择同步或异步调用
- **流式响应**：支持流式响应（逐步返回结果）
- **错误处理**：统一的错误处理和重试机制
- **请求去重机制**（性能优化）：
  - 相同请求的缓存和复用（基于参数哈希）
  - 短时间内的重复请求自动合并
  - 减少不必要的 AI 调用，提升性能

### 5.4 响应处理

- **响应解析**：解析 AI 返回的文本、工具调用等
- **去重处理**：前端和后端双重去重，避免重复内容
- **格式转换**：将 AI 响应转换为编辑器可用的格式
  - **格式适配**：根据当前文档格式转换 AI 响应
    - **TXT 格式**：去除所有格式标记，保留纯文本
    - **t-docx 格式**：保留或转换为 t-docx 支持的样式（标题、粗体、斜体、列表等）
    - **Markdown 格式**：保留或转换为 Markdown 语法
    - **HTML 格式**：保留或转换为 HTML 标签
  - **样式验证**：验证生成的格式是否符合当前文档格式规范
- **智能 Chunk 分割**（流式响应优化）：
  - 按句子边界分割（句号、问号、感叹号等），避免在单词中间分割
  - 支持 offset 跟踪，避免重复解析
  - 提升流式显示的流畅度和可读性

---

## 六、结果应用机制

### 6.1 结果类型

1. **文本内容**
   - 续写文本
   - 修改后的文本
   - 生成的代码/内容

2. **工具调用**
   - 文件操作（创建、更新、删除等）
   - 编辑器操作（修改文档内容）

3. **结构化数据**
   - 分析结果
   - 提取的信息

### 6.2 应用到编辑器

- **插入内容**：在光标位置插入文本
- **替换内容**：替换选中文本或指定位置的内容
- **追加内容**：追加到文档末尾
- **创建文件**：创建新文件并写入内容
- **格式和样式保持**：
  - **格式匹配**：确保插入的内容格式与当前文档格式一致
  - **样式继承**：继承当前光标位置的样式（如 t-docx 中的段落样式、文本样式）
  - **格式转换**：如果 AI 生成的内容格式与文档格式不一致，自动转换
    - 例如：AI 生成 Markdown 格式，但当前文档是 t-docx，需要转换为 t-docx 支持的样式

### 6.3 应用到文档

- **直接应用**：直接修改文档内容
- **预览确认**：显示预览（Diff 视图），用户确认后应用
- **批量应用**：批量应用到多个位置或文件

### 6.4 可视化反馈

- **Diff 视图**：显示修改前后的对比（红删绿增）
- **进度提示**：长时间操作显示进度
- **状态反馈**：操作成功/失败的明确反馈

---

## 七、共享配置和设置

### 7.1 API Key 管理

- **加密存储**：API Key 加密存储，不记录日志
- **密钥链集成**：支持系统密钥链（macOS Keychain、Windows Credential Manager）
- **多提供商支持**：支持多个 AI 提供商的 API Key

### 7.2 模型配置

- **模型选择**：用户可为不同功能选择不同模型
- **参数配置**：温度、最大 Token、超时等参数可配置
- **默认配置**：为不同功能提供合理的默认配置

### 7.3 提示词模板

- **基础系统提示词**：统一的角色定义和行为规范
- **功能特定提示词**：各功能可扩展基础提示词
- **动态提示词**：根据上下文动态构建提示词

---

## 八、错误处理和重试机制

### 8.1 错误类型

- **网络错误**：连接失败、超时等
- **API 错误**：API Key 无效、配额不足等
- **解析错误**：响应格式错误、工具调用参数错误等
- **错误级别分类**：
  - **Error**：严重错误，影响功能使用（API Key 无效、网络连接失败等）
  - **Warning**：警告信息，功能可用但可能有问题（配额不足、响应超时等）
  - **Info**：提示信息，不影响功能（响应被过滤、部分内容未返回等）

### 8.2 错误处理策略

- **自动重试**：网络错误、超时错误自动重试（最多 3 次，指数退避）
- **错误提示优化**：用户友好的错误提示和解决建议
  - 不同错误级别采用不同的提示方式（Error 显示错误提示，Warning 显示警告，Info 显示提示）
  - 提供具体的错误原因和解决建议
  - 支持错误恢复操作（重试、跳过等）
- **降级处理**：主模型失败时尝试备用模型
- **错误详情扩展**：
  - 检测响应是否不完整（`responseIsIncomplete`）
  - 检测响应是否被过滤（`responseIsFiltered`）
  - 检测配额是否超限（`isQuotaExceeded`）
  - 提供更详细的错误信息，帮助用户理解问题

### 8.3 重试机制

- **重试条件**：网络错误、超时错误、5xx 服务器错误
- **不重试条件**：4xx 客户端错误（API Key 无效等）、用户取消
- **重试策略**：指数退避，静默重试（不打扰用户）

---

## 九、性能优化

### 9.1 请求优化

- **请求队列**：管理多个 AI 请求，按优先级处理
- **请求取消**：支持取消正在进行的请求
- **并发控制**：控制并发请求数量，避免资源耗尽

### 9.2 响应优化

- **流式响应**：逐步返回结果，提升用户体验
- **去重机制**：前端和后端双重去重，避免重复内容
- **缓存机制**：适当缓存常用结果，减少 AI 调用

### 9.3 上下文优化

- **智能选择**：只选择最相关的上下文，减少 Token 消耗
- **内容压缩**：大文档时智能压缩，保留关键信息
- **分批处理**：大任务分批处理，避免超时

---

## 十、安全性和隐私

### 10.1 数据安全

- **API Key 加密存储**：API Key 加密存储，不记录日志
  - **API Key 安全监控**：
    - API Key 使用监控（使用频率、调用次数等）
    - 支持 API Key 轮换机制
    - 异常使用检测和告警
- **本地处理**：敏感信息优先本地处理，减少网络传输
- **数据清理**：临时数据及时清理，不持久化敏感信息
- **敏感信息过滤**（隐私保护）：
  - 自动检测敏感信息（密码、密钥、API Key、个人信息等）
  - 敏感信息脱敏处理（发送给 AI 前自动过滤或替换）
  - 敏感信息使用警告（检测到敏感信息时提示用户）
  - 确保用户隐私安全

### 10.2 隐私保护

- **用户数据**：用户文档内容仅在本地处理，不发送到第三方（除非用户明确同意）
- **日志记录**：不记录用户文档内容和 AI 响应内容
- **数据最小化**：只发送必要的上下文信息给 AI
- **敏感信息过滤**（见 9.1）
- **数据清理机制**：
  - 临时数据及时清理
  - 会话数据过期清理
  - 用户数据删除机制

---

## 十一、扩展性设计

### 11.1 新 AI 提供商接入

- **统一接口**：通过 `AIProvider` trait 统一接口
- **配置化**：新提供商通过配置即可接入
- **模型管理**：统一的模型管理和选择机制

### 11.2 新功能扩展

- **插件化设计**：新功能可作为独立模块扩展
- **共享机制**：复用基础功能（上下文获取、AI 调用、结果处理）
- **配置驱动**：通过配置驱动功能行为

---

## 十二、总结

### 12.1 核心原则

1. **统一性**：所有 AI 功能使用统一的基础机制
2. **可扩展性**：易于扩展新的 AI 提供商和功能
3. **性能**：优化请求和响应处理，提升用户体验
4. **安全性**：保护用户数据和隐私

### 12.2 关键机制

- **上下文信息收集**：智能选择最相关的上下文
- **提示词构建**：分层构建，动态调整
- **AI 服务调用**：统一接口，多提供商支持
- **结果处理**：统一处理，灵活应用
- **错误处理**：自动重试，友好提示

---

**文档版本**：v1.0  
**创建日期**：2025年  
**维护者**：Binder 开发团队

